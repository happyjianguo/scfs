<div class="wrapper">
    <section class="content-header my-content-header">
        <ol class="breadcrumb">
            <li>当前位置</li>
            <li>发票</li>
            <li>开票申请</li>
            <li class="active">新建发票</li>
        </ol>
    </section>
    <section class="product-wrap">
          <div class="box no-margin">
              <form class="form-horizontal form-inline" id="form1">
                  <div class="box-body">
                      <div class="row">
                          <div class="col-md-6">
                              <table class="table table-bordered table-hover no-margin">
                                  <tr>
                                      <td width="180" class="text-right"><b>项目：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <select class="form-control js-select" data-url="USER_PROJECT" id="projectId" name="projectId"> </select>
                                      </td>
                                  </tr>
                                  <tr>
                                      <td class="text-right"><b>客户：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <select class="form-control js-select" data-url="PROJECT_BCS" pid="projectId" id="customerId" name="customerId"> </select>
                                      </td>
                                  </tr>
                                  <tr>
                                      <td class="text-right"><b>票据类型：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <select class="form-control js-select" data-url="INVOICE_TYPE" id="invoiceType" name="invoiceType"> </select>
                                      </td>
                                  </tr>
                                  <tr id="isElecInvoice1" style="display: none;">
                                      <td class="text-right"><b>电子普通发票：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <input type="radio" id="isElecInvoice" name="isElecInvoice" value="1" />是
                                          <input type="radio" id="isElecInvoice" name="isElecInvoice" value="0" checked="checked" />否
                                      </td>
                                  </tr>
                                  <tr>
                                      <td class="text-right"><b>开票信息    ：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <select class="form-control js-select" data-url="SUBJECT_INVICE" id="baseInvoiceId" name="baseInvoiceId"> </select>
                                      </td>
                                  </tr>
                                  <tr id="identifyNumber1" style="display: none;">
                                      <td class="text-right"><b>纳税人识别号    ：<em class="text-star">*</em> </b></td>
                                      <td class="text-left">
                                          <input type="text" class="form-control" id="identifyNumber" name="identifyNumber" readonly="readonly">
                                      </td>
                                  </tr>
                                  <tr id="bankDeposite1" style="display: none;">
                                      <td class="text-right"><b>开户银行    ：<em class="text-star">*</em> </b></td>
                                      <td class="text-left">
                                          <input type="text" class="form-control" id="bankDeposite" name="bankDeposite" readonly="readonly">
                                      </td>
                                  </tr>
                                  <tr id="accountOpen1" style="display: none;">
                                      <td class="text-right"><b>开户帐号    ：<em class="text-star">*</em> </b></td>
                                      <td class="text-left">
                                          <input type="text" class="form-control" id="accountOpen" name="accountOpen" readonly="readonly">
                                      </td>
                                  </tr>
                                  <tr id="billAddress1" style="display: none;">
                                      <td class="text-right"><b>开票地址    ：<em class="text-star">*</em> </b></td>
                                      <td class="text-left">
                                          <input type="text" class="form-control" id="billAddress" name="billAddress" readonly="readonly">
                                      </td>
                                  </tr>
                                  <tr id="billMobile1" style="display: none;">
                                      <td class="text-right"><b>开票电话    ：<em class="text-star">*</em> </b></td>
                                      <td class="text-left">
                                          <input type="text" class="form-control" id="billMobile" name="billMobile" readonly="readonly">
                                      </td>
                                  </tr>
                                  <tr>
                                      <td class="text-right"><b>单据类别：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <select class="form-control js-select" data-url="DOCUMENT_TYPE" id="billType" name="billType"> </select>
                                      </td>
                                  </tr>
                                  <tr id="billDetail1" style="display: none;">
                                      <td class="text-right"><b>开票明细：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <select class="form-control js-select" data-url="BILL_DETAIL" id="feeType" name="feeType"> </select>
                                      </td>
                                  </tr>
                                  <tr id="billRate1" style="display: none;">
                                      <td class="text-right"><b>开票税率：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <select class="form-control js-select" data-url="PROVIDE_INVOICE_TAX_RATE" id="invoiceTaxRate" name="invoiceTaxRate"> </select>
                                      </td>
                                  </tr>
                                  <tr id="taxCateNo1" style="display: none;">
                                      <td class="text-right"><b>税收分类编码：</b></td>
                                      <td class="text-left">
                                          <input type="text" class="form-control" id="taxCateNo" name="taxCateNo">
                                      </td>
                                  </tr>
                                  <tr id="isGoodsMerge1" style="display: none;">
                                      <td class="text-right"><b>同品合并：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <input type="radio" id="isGoodsMerge" name="isGoodsMerge" value="1" checked="checked" />是
                                          <input type="radio" id="isGoodsMerge" name="isGoodsMerge" value="0" />否
                                      </td>
                                  </tr>
                                  <tr id="isDisplayDiscount1" style="display: none;">
                                      <td class="text-right"><b>显示折扣：<em class="text-star">*</em></b></td>
                                      <td class="text-left">
                                          <input type="radio" id="isDisplayDiscount" name="isDisplayDiscount" value="1" />是
                                          <input type="radio" id="isDisplayDiscount" name="isDisplayDiscount" value="0" checked="checked" />否
                                      </td>
                                  </tr>
                                  <tr id="discount1" style="display: none;">
                                      <td class="text-right"><b>固定折扣率：</b></td>
                                      <td class="text-left">
                                          <input type="text" class="form-control" id="discount" name="discount">%
                                      </td>
                                  </tr>
                                  <tr>
                                      <td class="text-right"><b>票据备注：</b></td>
                                      <td class="text-left">
                                          <textarea class="form-control" id="invoiceRemark" cols="50" rows="5" name="invoiceRemark"></textarea>
                                      </td>
                                  </tr>
                                  <tr>
                                      <td class="text-right"><b>单据备注：</b></td>
                                      <td class="text-left">
                                          <textarea class="form-control" id="remark" cols="50" rows="5" name="remark"></textarea>
                                      </td>
                                  </tr>
                              </table>
                          </div>
                      </div>
                  </div>
                  <!-- /.box-body -->
                  <div class="box-footer text-center">
                      <button type="submit" id="save" data-url="html/invoice/makeinvoice/invoiceSearch.html" data-permissionUrl="/invoiceService/add" class="btn btn-primary btn-sm">保存</button>
                      <button type="button" data-url="html/invoice/makeinvoice/invoiceSearch.html" id="js-back" class="btn btn-default btn-sm">返回</button>
                  </div>
                  <!-- /.box-footer -->
              </form>
          </div>
    </section>
</div>
<script>
var options = {
    param: {
        id: 0,
        cid: 0
    },
    initPage: function() {

        $("#customerId").change(function() {
            var id = $("#customerId").val();
            var data = {
                id: id
            };
            var opt = "<option value=''>请选择</option>";
            if (data) {
                GLOBAL.ajax("baseSubject/invoice/query", data, function(e) {
                    if (e.items) {
                        for (var k = 0; k < e.items.length; k++) {
                            opt += '<option value="' + e.items[k].id + '">' + e.items[k].taxPayer + '</option>';
                        }
                    }
                    $("#baseInvoiceId").empty().append(opt);
                });
            }
        });
        $("#invoiceType").change(function() {
            var id = $("#invoiceType").val();
            if (id == 2) {
                $("#baseInvoiceId").rules("add", {
                    required: true
                });
                $("#isElecInvoice1").hide().find("[name='isElecInvoice']:checked").prop("checked", false);
                $("#baseInvoiceId").val(" ");
                $("#identifyNumber1").hide().find("#identifyNumber").val("");
                $("#bankDeposite1").hide().find("#bankDeposite").val("");
                $("#accountOpen1").hide().find("#accountOpen").val("");
                $("#billAddress1").hide().find("#billAddress").val("");
                $("#billMobile1").hide().find("#billMobile").val("");
            } else if (id == 3) {
                $("#baseInvoiceId").rules("remove");
                $("#isElecInvoice1").show();
                $("#isElecInvoice").rules("add", {
                    required: true
                });
                $("#baseInvoiceId").val("");
                $("#identifyNumber1").hide().find("#identifyNumber").val("");
                $("#bankDeposite1").hide().find("#bankDeposite").val("");
                $("#accountOpen1").hide().find("#accountOpen").val("");
                $("#billAddress1").hide().find("#billAddress").val("");
                $("#billMobile1").hide().find("#billMobile").val("");
            } else {
                $("#identifyNumber1").hide().find("#identifyNumber").val("");
                $("#bankDeposite1").hide().find("#bankDeposite").val("");
                $("#accountOpen1").hide().find("#accountOpen").val("");
                $("#billAddress1").hide().find("#billAddress").val("");
                $("#billMobile1").hide().find("#billMobile").val("");
                $("#baseInvoiceId").val("");
                $("#isElecInvoice1").hide().find("[name='isElecInvoice']:checked").prop("checked", false);
            }
        });
        $("#baseInvoiceId").change(function() {
            var subjectId = $("#baseInvoiceId").val();

            $("#identifyNumber1").show();
            $("#bankDeposite1").show();
            $("#accountOpen1").show();
            $("#billAddress1").show();
            $("#billMobile1").show();
            if (subjectId) {
                var data = {
                    id: subjectId
                };
                GLOBAL.ajax("baseSubject/invoiceById/query", data, function(e) {
                    if (e.items) {
                        $("#identifyNumber").val(e.items.taxPayer);
                        $("#bankDeposite").val(e.items.bankName);
                        $("#accountOpen").val(e.items.accountNo);
                        $("#billAddress").val(e.items.address);
                        $("#billMobile").val(e.items.phoneNumber);
                    }
                });
            } else {
                $("#identifyNumber1").hide();
                $("#bankDeposite1").hide();
                $("#accountOpen1").hide();
                $("#billAddress1").hide();
                $("#billMobile1").hide();
            }
        });
        $("#billType").change(function() {
            var id = $("#billType").val();
            if (id == 1) {
                $("#billDetail1").hide().find("#billDetail").val("");
                $("#billRate1").hide().find("#billRate").val("");
                $("#taxCateNo1").hide().find("#taxCateNo").val("");
                $("#isGoodsMerge1").show();
                $("#isDisplayDiscount1").show();
                $("#discount1").show();
            } else if (id == 2) {
                $("#billDetail1").show();
                $("#billRate1").show();
                $("#taxCateNo1").show();
                $("#isGoodsMerge1").hide().find("[name='isGoodsMerge']:checked").prop("checked", false);
                $("#isDisplayDiscount1").hide().find("[name='isDisplayDiscount']:checked").prop("checked", false);
                $("#discount1").hide().find("#discount").val("");

            } else if (id == "") {
                $("#billDetail1").hide().find("#billDetail").val("");
                $("#billRate1").hide().find("#billRate").val("");
                $("#taxCateNo1").hide().find("#taxCateNo").val("");
                $("#isGoodsMerge1").hide().find("#isGoodsMerge").val("");
                $("#isDisplayDiscount1").hide().find("#isDisplayDiscount").val("");
                $("#discount1").hide().find("#discount").val("");
            }
        });

        $("#form1").validate({
            rules: {
                customerId: {
                    required: true
                },
                projectId: {
                    required: true
                },
                invoiceType: {
                    required: true
                },
                billType: {
                    required: true
                },
                billDetail: {
                    required: true
                },
                billRate: {
                    required: true
                },
                discount: {
                    required: true
                },
                isDisplayDiscount: {
                    required: true
                },
                isGoodsMerge: {
                    required: true
                }
            },
            submitHandler: function() {
                if ($("#discount").val() < 0 || $("#discount").val() > 50) {
                    layer.msg("固定折扣率在0-50之间！");
                    return false;
                }
                var data = $("#form1").serialize();
                GLOBAL.ajax("invoiceService/add", data, function(e) {
                    layer.msg("保存成功！", {
                        icon: 1,
                        time: 1500
                    }, function() {
                        options.param.id = e.items;
                        options.param.cid = e.items;
                        options.param.billType = $("#billType").val();
                        GLOBAL.go("html/invoice/makeinvoice/InvoiceEdit.html", options.param);
                    })

                });
            }
        });
    }
}

$(".js_datePicker").datetimepicker();

$("#js-back").click(function() {
    var url = $(this).data("url");
    GLOBAL.go(url);
})
</script>
