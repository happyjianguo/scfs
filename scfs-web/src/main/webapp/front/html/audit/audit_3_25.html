<div class="wrapper">
  <ol class="breadcrumb">
    <li>当前位置</li>
    <li>物流</li>
    <li>出库单</li>
    <li class="active">财务专员审核</li>
  </ol>
  <!--引入面包屑-->
  <section class="product-wrap">
      <div class="box no-margin"> 
        <form class="form-horizontal" id="billOutStoreAuditInfoForm" data-url="billOutStore/info/audit">
          <div class="box-header">
            <input class="js-initform" type="hidden" id="id" name="id">
            <h3>财务专员审核</h3>
            <table class="table table-bordered table-hover no-margin">
          	  <tr>
                  <td width="180" class="text-right"><b>出库编号：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="billNo" name="billNo"></label>
                  </td>
                  
                  <td width="180" class="text-right"><b>出库附属编号：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="affiliateNo" name="affiliateNo"></label>
                  </td>
                </tr>

                <tr>
                  <td width="180" class="text-right"><b>出库类型：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="billTypeName" name="billTypeName"></label>
                  </td>
                  
                  <td class="text-right"><b>项目：</b></td>
                  <td class="text-left">
                      <label class="js-initform" id="projectName" name="projectName"></label>
                  </td>
                </tr>
                
                <tr>
                  <td class="text-right"><b>发货仓库：</b></td>
                  <td class="text-left">
                      <label class="js-initform" id="warehouseName" name="warehouseName"></label>
                  </td>
                  
                  <td class="text-right"><b>接收仓库：</b></td>
                  <td class="text-left">
                      <label class="js-initform" id="receiveWarehouseName" name="receiveWarehouseName"></label>
                  </td>
                </tr>

                <tr>             
                   <td class="text-right"><b>运输方式：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="transferModeName" name="transferModeName"></label>
                  </td>
                       
                  <td class="text-right"><b>送货地址：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="customerAddress" name="customerAddress"></label>
                  </td>
                </tr>

                <tr>
                  <td class="text-right"><b>客户：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="customerName" name="customerName"></label>
                  </td>  
                  
                  <td class="text-right"><b>要求发货日期：</b></td>
                  <td class="text-left">
                    <label type="text" class="js-initform" id="requiredSendDate" name="requiredSendDate"></label>
                  </td>
                </tr> 
                
                <tr>
                  <td class="text-right"><b>总数量：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="sendNum" name="sendNum"></label>
                  </td>                   
                  <td class="text-right"><b>总金额：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="sendAmount" name="sendAmount"></label>
                  </td>
                </tr>               

                <tr>
            		<td class="text-right"><b>币种：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="currencyTypeName" name="currencyTypeName"></label>
                  </td>
                  <td class="text-right"><b>签收标准：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="signStandardName" name="signStandardName"></label>
                  </td>                   
                </tr>
                
                <tr>
                  <td class="text-right"><b>签收人：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="certificateName" name="certificateName"></label>
                  </td>
                  <td class="text-right"><b>身份证：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="certificateId" name="certificateId"></label>
                  </td>
                </tr>
                
                <tr>                   
                  <td class="text-right"><b>公章：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="officialSeal" name="officialSeal"></label>
                  </td>                   
                  <td class="text-right"><b>状态：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="statusName" name="statusName"></label>
                  </td>
                </tr>

                <tr>
                  <td class="text-right"><b>出库时间：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="deliverTime" name="deliverTime"></label>
                  </td>                                     
                  <td class="text-right"><b>出库人：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="deliverer" name="deliverer"></label>
                  </td>
                </tr>
                
                <tr>
                  <td class="text-right"><b>备注：</b></td>
                  <td class="text-left">
                    <label class="js-initform" id="remark" name="remark"></label>  
                  </td>
                  <td class="text-right"></td>
                  <td class="text-left">
                  </td>
                </tr>
             </table>
          </div>
          <!-- /.box-header -->
          <div class="box-body">
          	<h4 class="title mt20 mb5">出库单明细</h4>
              <table id="js_dataTable"></table>
              <h4 class="title mt20 mb5">附件</h4>
            	<table id="js_dataFileTable"></table>
              <p class="text-center mt10">
                  <button type="button" data-url="billOutStoreFileList/downLoad" class="btn btn-primary btn-sm attachment-down">批量下载</button>
              </p>

              <h4 class="title mt20 mb5">审核记录</h4>
              <table id="js_audit_dataTable" data-url="billOutStore/auditflow/audit/query"></table>
          </div>
          <!-- .box-body -->
          <div class="box-footer text-center">
          	<div class="form-inline" style="width:500px; margin:auto">
              	<textarea style="margin-bottom: 10px; width:500px" class="form-control js-initform" id="suggestion" rows="3" name="suggestion" placeholder="审核意见"></textarea>
              	
              	<p class="mt20">
	              	<button type="button" data-permissionUrl="/billOutStore/finance/audit" data-url="billOutStore/finance/audit" class="btn btn-primary btn-sm" id="pass">审核通过</button> 
	              	<button type="button" data-permissionUrl="/billOutStore/unpass/audit" data-url="billOutStore/unpass/audit" class="btn btn-primary btn-sm punpass" id="unpass">审核不通过</button>             
	                <button type="button" data-permissionUrl="/billOutStore/finance/audit" data-url="billOutStore/finance/audit" class="btn btn-primary btn-sm" id="passAndNext">通过并审核下一个</button> 
	              	<button type="button" class="btn btn-default btn-sm js-back">返回</button> 
              	</p>
	        	<p class="mt20 psigh" style="display:none">
	            	<label class="control-label pull-rihgt">加签给:</label>
	            	<select class="form-control js-select" data-url="USER" id="sighId" name="sighId"></select>
	            	<button type="button" data-permissionUrl="/billOutStore/sigh/audit" data-url="billOutStore/sigh/audit" class="btn btn-primary btn-sm" id="sigh">加签</button>
	        	</p>
	        	<p class="mt20 pdeliver" style="display:none">
	            	<label class="control-label pull-rihgt">转交给:</label>
	            	<select class="form-control js-select" data-url="USER" id="deliverId" name="deliverId"></select>
	            	<button type="button" data-permissionUrl="/billOutStore/deliver/audit" data-url="billOutStore/deliver/audit" class="btn btn-primary btn-sm" id="deliver">转交</button>
	        	</p>
          	</div>
          </div>
          <!-- /.box-footer -->
        </form>
      </div>
  </section>
</div>

<script>
	/*数据表格*/
	var tabCols = [{  
	     title: '序号',
	     field: 'columnsNumber',  
	     width: 10
	 }, {
	     title: '商品编号',
	     field: 'goodsNumber',
	     width: 80,
	 }, {
         title: '商品条码',
         field: 'goodsBarCode',
         align: 'center'
     }, {
	     title: '商品名称',
	     field: 'goodsName',
	     align: 'center'
	 }, {
	     title: '商品型号',
	     field: 'goodsType',
	     align: 'center'
	 }, {
	     title: '发货数量',
	     field: 'sendNum',
	     align: 'center'
	 }, {
	     title: '拣货数量',
	     field: 'pickupNum',
	     align: 'center'
	 }, {
	     title: '出库单价',
	     field: 'sendPrice',
	     align: 'center'
	 }, {
	     title: '出库金额',
	     field: 'sendAmount',
	     align: 'center'
	 }, {
	     title: '订单金额',
	     field: 'poAmount',
	     align: 'center'
	 }, {
	     title: '成本金额',
	     field: 'costAmount',
	     align: 'center'
	 }, {
	     title: '批次',
	     field: 'batchNo',
	     align: 'center'
	 }, {
	     title: '库存状态',
	     field: 'goodsStatus',
	     align: 'center'
	 }];
	
	var auditTabCols = [{
	    title: '序号',
	    field: 'columnsNumber',
	    width: '5%'
	}, {
	    title: '流程节点',
	    field: "stateName",
	    width: '15%'
	}, {
	    title: '处理人',
	    field: "dealName",
	    width: '15%'
	}, {
	    title: '处理意见',
	    field: "suggestion",
	    width: '25%'
	}, {
	    title: '开始时间',
	    field: "createTime",
	    width: '15%'
	}, {
	    title: "处理时间",
	    field: "dealTime",
	    width: '15%'
	}, {
	    title: "处理状态",
	    field: "auditStateName",
	    width: '10%'
	}];
	
	/*附件*/
	window.operateEvents = {
		'click .download': function(e, value, row, index){
  			var url = GLOBAL.host + "billOutStoreFile/downLoad?fileId="+row.id;
  			GLOBAL.preview({type: row.type, url: url});
	   },
    
	};
	function operateFormatter(value, row, index) {
	    return [
	            '<a class="download" href="javascript:void(0)">',
	            '<span class="btn btn-primary btn-sm">下载</span>',
	            '</a>  '
	        ].join('');
	}
	/*数据表格*/
	var fileCols = [
      {
          field: 'checkItem',
          checkbox: true,
      },{  
		     title: '序号',
		     field: 'columnsNumber',  
		     width: 10
	     },{
		     title: '文件名称',
		     field: 'name',
		     width: 92,
		     align: 'center'
		 },  {
		     title: '文件类型',
		     field: 'type',
		     width: 80,
		     align: 'center'
		 },  {
		     title: '上传人',
		     field: 'creator',
		     width: 80,
		     align: 'center'
		 },  {
		     title: '上传时间',
		     field: 'createAt',
		     width: 80,
		     align: 'center'
		 }, {
		     title: '操作',
		     field: 'operta',
		     width: 100,
		     align: 'center',
		     events: operateEvents,
	         formatter: operateFormatter
		 }
	];
	options.initPage = function() {
		var $from = $("#billOutStoreAuditInfoForm");
		var url = $from.data("url");
 	    GLOBAL.ajax(url, {id: options.param.poId}, function(e) {
        	if (e.success) {
        		var data = e.items.billOutStoreResDto;
              	if (data) {
              		$(".js-initform", $from).each(function() {
                        var $this = $(this);
                        var id = $this.attr("id");
                        var toThound = $this.hasClass("toThound");
                        data[id] = data[id] == null ? "" : data[id];
                        
                        if(this.nodeName.toLowerCase() == "label") {
                            if(data[id]) {
                            	var showValue = toThound && !isNaN(parseFloat(data[id])) ? parseFloat(data[id]).toThounds() : data[id];
                                $this.text(showValue);
                            }
                        } else {
                            $this.val(data[id]);
                        }
              		});
              	}
              	//添加销售单附件信息
              	var fileAttachList = e.items.billOutStoreFileList;
                if(fileAttachList){
                	 GLOBAL.initTable($('#js_dataFileTable'), fileCols, null, fileAttachList, {pagination: false});
                }
              	var dtls = e.items.billOutStoreDtlResDtoList;
              	if (dtls) {
                    GLOBAL.initTable($('#js_dataTable'), tabCols, null, dtls, {pagination: false});
                    GLOBAL.initTable($('#js_audit_dataTable'), auditTabCols, {
                    	billOutStoreId: options.param.poId
                    }, null, {
                        pagination: false
                    });
                    GLOBAL.ajax('audit/id/query', {
                        id: options.param.id
                    }, function(e) {
                    	var data = e.items;
                        if (data) {
                        	if(data.auditType==1||data.auditType==2){
                        		$(".psigh,.pdeliver").show();
                        	}else{
                        		$(".punpass").hide();
                        	}
                        }
                    });
              	}
            }
        });
	}

  	$("#pass").click(function(){
  		var suggestion = $("#suggestion").val();
    	var url = $(this).data("url");
 	    GLOBAL.ajax(url, {auditId: options.param.id, billOutStoreId: options.param.poId, suggestion: suggestion || ""}, function(e) {
        	if (e.success) {
              	layer.msg("审核通过成功！");
              	if (options.param.entryType == 1) {
                  	GLOBAL.go("html/entry.html");
              	} else {
              		GLOBAL.go("html/audit/audit.html");
              	}
            } else {
                layer.msg(e.msg);
            }
        });
  	})
  	$("#passAndNext").click(function(){
  		var suggestion = $("#suggestion").val();
    	var url = $(this).data("url");
 	    GLOBAL.ajax(url, {auditId: options.param.id, billOutStoreId: options.param.poId, suggestion: suggestion || ""}, function(e) {
        	if (e.success) {
        		GLOBAL.ajax("/audit/next/query", "", function(e) {
                    if (e.success) { 
                    	 if(e.items){
                    		 var id = e.items.id;
                             var state = e.items.state;
                             var poId = e.items.poId;
                             var poType = e.items.poType;
                             options.param.id = id;
                             options.param.poId = poId;  
                             if (poType && state) { 
                                 GLOBAL.go("html/audit/audit_" + poType + "_" + state + ".html");
                             }
                    	 }else{
                    		 GLOBAL.go("html/entry.html");
                    	 }  
                    } else {
                        layer.msg(e.msg);
                    }
                });
            } else {
                layer.msg(e.msg);
            }
        });
  	})
  	
  	$("#unpass").click(function(){
  		var suggestion = $("#suggestion").val();
  		if (!suggestion) {
          	layer.msg("请输入审核意见");
			return;
  		}
    	var url = $(this).data("url");
 	    GLOBAL.ajax(url, {auditId: options.param.id, billOutStoreId: options.param.poId, suggestion: suggestion}, function(e) {
        	if (e.success) {
              	layer.msg("审核不通过成功！");
              	if (options.param.entryType == 1) {
                  	GLOBAL.go("html/entry.html");
              	} else {
              		GLOBAL.go("html/audit/audit.html");
              	}
            } else {
                layer.msg(e.msg);
            }
        });
  	})
  	
  	$("#sigh").click(function() {
	    var url = $(this).data("url");
	    var sighId = $("#sighId").val();

      if(sighId){
          layer.confirm('确定加签吗？', {
              btn: ['确定','取消'] //按钮
          }, function(){
              GLOBAL.ajax(url, {
                  auditId: options.param.id,
                  pauditorId: sighId
              }, function(e) {
                  if (e.success) {
                      layer.msg("加签成功！");
                      $("#sighId").val("");
                      GLOBAL.tableRefresh($('#js_audit_dataTable'), {
                        billOutStoreId: options.param.poId
                      });
                  } else {
                      layer.msg(e.msg);
                  }
              });
          });
      }else{
          layer.msg("请选择！");
          $("#sighId").focus();
      }
	})
	
	$("#deliver").click(function() {
	    var url = $(this).data("url");
	    var deliverId = $("#deliverId").val();

      if(deliverId){
          layer.confirm('确定转交吗？', {
              btn: ['确定','取消'] //按钮
          }, function(){
             GLOBAL.ajax(url, {
                  auditId: options.param.id,
                  pauditorId: deliverId
              }, function(e) {
                  if (e.success) {
                      layer.msg("转交成功！");
                      $("#deliverId").val("");
                      if (options.param.entryType == 1) {
                          GLOBAL.go("html/entry.html");
                      } else {
                          GLOBAL.go("html/audit/audit.html");
                      }
                  } else {
                      layer.msg(e.msg);
                  }
              });
          });
      }else{
          layer.msg("请选择！");
          $("#deliverId").focus();
      } 
	})

  $(".attachment-down").click(function() {
      var ids = GLOBAL.selectIds($("#js_dataFileTable"));
      if (ids) {
          var url = GLOBAL.host + $(this).data("url") + "?ids=" + ids;
          window.open(url);
      }
  })
	
	$(".js-back").click(function(){
      	if (options.param.entryType == 1) {
          	GLOBAL.go("html/entry.html");
      	} else {
      		GLOBAL.go("html/audit/audit.html");
      	}
  	})

</script>

