<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>瑞翰供应链</title>
<script src="../../js/lib/flexible.js" type="text/javascript"></script>
<link href="../../css/base.css" rel="stylesheet"></link>
<link href="../../css/public.css" rel="stylesheet"></link>
<link href="../../css/mobile.css" rel="stylesheet"></link>
<link href="../../css/msg.css" rel="stylesheet"></link>
</head>
<body>
	<div class="wrapper mb20">
		<h4 class="title mb10 ml5 mt5">
			<strong>部门主管审核</strong>
		</h4>
		<form class="audit-form" id="form1" data-url="projectItem/info/audit">
			<input class="form-control js-initform" type="hidden" id="id"
				name="id">
			<p>
				<span class="form-label">编号</span> <span
					class="form-value js-initform" id="itemNo"></span>
			</p>
			<p>
				<span class="form-label">项目</span> <span
					class="form-value js-initform" id="projectName"></span>
			</p>
			<p>
				<span class="form-label">业务类型</span> <span
					class="form-value js-initform" id="businessType"></span>
			</p>
			<p>
				<span class="form-label" style="width: 1.5rem;">有效期</span> <span
					class="form-value" style="width: 7.5rem;"> <span
					class="js-initform" id="startDate"></span> 至 <span
					class="js-initform" id="endDate"></span>
				</span>
			</p>
			<p>
				<span class="form-label">额度总额</span> <span
					class="form-value js-initform" id="amountCurrencyValue"></span>
			</p>
			<p>
				<span class="form-label">结算类型</span> <span
					class="form-value js-initform" id="isFundAccountName"></span>
			</p>
			<p>
				<span class="form-label">结算计费方式</span> <span
					class="form-value js-initform" id="paypalCalcTypeName"></span>
			</p>
			<p>
				<span class="form-label" style="vertical-align: top;">分段规则</span> <span
					class="form-value js-initform segment-input-box"></span>
			</p>
			<p>
				<span class="form-label">合作账期</span> <span
					class="form-value js-initforms" id="fundAccountPeriod"
					style="width: 4.4rem">25</span>天
			</p>
			<p>
				<span class="form-label">日服务费率</span> <span
					class="form-value js-initform" id="fundMonthRate"></span>
			</p>
			<p>
				<span class="form-label">日违约金费率</span> <span
					class="form-value js-initform" id="dayPenalRate"></span>
			</p>
			<p>
				<span class="form-label">违约宽限期</span> <span
					class="form-value js-initform" id="penalGracePeriod"
					style="width: 4.4rem"></span>天
			</p>
			<p>
				<span class="form-label">是否固定点数</span> <span
					class="form-value js-initform" id="fixedpointsValue"></span>
			</p>


			<p>
				<span class="form-label">价差固定点数</span> <span
					class="form-value js-initform" id="spreadfixedpoints"></span>
			</p>
			<p>
				<span class="form-label">计算操作费</span> <span
					class="form-value js-initform" id="isOperateAccountValue"></span>
			</p>

			<p>
				<span class="form-label">操作服务费率</span> <span
					class="form-value js-initform" id="operateFeeRate"></span>
			</p>
			<p>
				<span class="form-label">项目对账方式</span> <span
					class="form-value js-initform" id="projectchecktypeValue"></span>
			</p>
			<p>
				<span class="form-label">项目对账日期</span> <span
					class="form-value js-initform" id="projectcheckdate"
					style="width: 4.4rem"></span>号
			</p>
			<p>
				<span class="form-label">客户对账方式</span> <span
					class="form-value js-initform" id="clientchecktypeValue"></span>
			</p>
			<p>
				<span class="form-label">客户对账日期</span> <span
					class="form-value js-initform" id="clientCheckDay"
					style="width: 4.4rem"></span>号
			</p>

			<p>
				<span class="form-label">供应商对账方式</span> <span
					class="form-value js-initform" id="supplierchecktypeValue"></span>
			</p>
			<p>
				<span class="form-label">供应商对账日期</span> <span
					class="form-value js-initform" id="supplierCheckDay"
					style="width: 4.4rem"></span>号
			</p>
			<p>
				<span class="form-label">预收客户比例</span> <span
					class="form-value js-initform" id="payRate"></span>
			</p>
			<p>
				<span class="form-label">代理出口</span> <span
					class="form-value js-initform" id="isAgencyExportValue"></span>
			</p>
			<p>
				<span class="form-label">代理出口费率</span> <span
					class="form-value js-initform" id="agencyExportRate"></span>
			</p>
			<p>
				<span class="form-label">代理进口</span> <span
					class="form-value js-initform" id="isagencyimportValue"></span>
			</p>
			<p>
				<span class="form-label">代理进口费率</span> <span
					class="form-value js-initform" id="agencyimportrate"></span>
			</p>

			<p>
				<span class="form-label">结算汇率</span> <span
					class="form-value js-initform" id="accountRateTypeValue"></span>
			</p>
			<p>
				<span class="form-label">银行名称</span> <span
					class="form-value js-initform" id="bankName" name="bankName"></span>
			</p>
			<p>
				<span class="form-label">固定汇率</span> <span
					class="form-value js-initform" id="accountRate" name="accountRate"></span>
			</p>
			<p>
				<span class="form-label">签收标准</span> <span
					class="form-value js-initform" id="signStandardValue"
					name="signStandardValue"></span>
			</p>
			<p>
				<span class="form-label">姓名</span> <span
					class="form-value js-initform" id="certificateName"
					name="certificateName"></span>
			</p>

			<p>
				<span class="form-label">身份证号码</span> <span
					class="form-value js-initform" id="certificateId"
					name="certificateId"></span>
			</p>
			<p>
				<span class="form-label">公章名</span> <span
					class="form-value js-initform" id="officialSeal"
					name="officialSeal"></span>
			</p>
			<p>
				<span class="form-label">库龄期限</span> <span
					class="form-value js-initform" id="libraryAge" name="libraryAge"></span>
			</p>
			<p>
				<span class="form-label">备注</span> <span
					class="form-value js-initform" id="remark" name="remark"></span>
			</p>
		</form>
		<!-- 审核记录 -->
		<h4 class="title mb10 ml5 mt5 audit-record-title">
			<strong>审核节点</strong>
		</h4>
		<div class="audit-record-box">
			<ul></ul>
		</div>
		<div class="box-footer text-center mb10">
			<div class="form-inline" id="buttom1">
				<textarea class="form-control js-initform" id="suggestion" rows="3"
					name="suggestion" placeholder="审核意见"></textarea>
				<p class="mt20">
					<button type="button" data-url="projectItem/deptManage/audit"
						data-permissionUrl="/projectItem/deptManage/audit"
						class="btn btn-primary btn-sm" id="pass">审核通过</button>
					<button type="button" data-url="projectItem/unpass/audit"
						data-permissionUrl="/projectItem/unpass/audit"
						class="btn btn-primary btn-sm punpass" id="unpass">审核不通过</button>
					<button type="button" class="btn btn-default btn-sm js-back">返回</button>
				</p>
				<div class="row mt20 psigh" style="display: none">
					<label class="control-label col-md-2">加签给:</label> <select
						class="form-control col-md-8 js-select" data-url="USER"
						id="sighId" name="sighId"></select>
					<button type="button" data-url="projectItem/sigh/audit"
						data-permissionUrl="/projectItem/sigh/audit"
						class="btn btn-primary btn-sm col-md-2" id="sigh">加签</button>
				</div>
				<div class="row mt20 pdeliver" style="display: none">
					<label class="control-label col-md-2">转交给:</label> <select
						class="form-control col-md-8 js-select" data-url="USER"
						id="deliverId" name="deliverId"></select>
					<button type="button" data-url="projectItem/deliver/audit"
						data-permissionUrl="/projectItem/deliver/audit"
						class="btn btn-primary btn-sm col-md-2" id="deliver">转交</button>
				</div>
			</div>
			<div class="form-inline" style="display: none" id="buttom2">
				<p class="mt20">
					<button type="button" class="btn btn-default btn-sm js-back">返回</button>
				</p>
			</div>
		</div>
	</div>
	<script src="../../../js/lib/jquery-1.11.0.min.js"
		type="text/javascript"></script>
	<script src="../../js/common.js?v=1.0.0"></script>
	<script> 
        var id = GLOBAL.getParam("id");
        var poId = GLOBAL.getParam("poId"); 
        var flag = GLOBAL.getParam("flag");

        if(flag){
            $('#buttom2').show();
            $('#buttom1').hide();
        }
          
        $(function() {
            var $from = $("#form1");
            var url = $from.data("url");
            GLOBAL.ajax(url, {  projectItemId: poId }, function(e) {
                if (e.success) {
                    var data = e.items.projectItem; 
                    if (data) {
                        $(".js-initform", $from).each(function() {
                            var $this = $(this);
                            var id = $this.attr("id");
                            data[id] = data[id] == null ? "" : data[id];
                            if (this.nodeName.toLowerCase() == "span") {
                                if (data[id] || data[id] == 0) {
                                    $this.text(data[id]);
                                }
                            } else {
                                $this.val(data[id]);
                            }
                        });
                        GLOBAL.ajax('audit/id/query', {
                            id: id
                        }, function(e) {
                            var data = e.items;
                            if (data) {
                                if (data.auditType == 1 || data.auditType == 2) {
                                    $(".psigh,.pdeliver").show();
                                } else {
                                    $(".punpass").hide();
                                }
                                if(data.auditState == 1 || data.auditState == 3){//审核通过，隐藏
                                    $('#buttom2').show();
                                    $('#buttom1').hide();
                                }
                            }
                        });
                        if ($("#isFundAccountName").html() == "资金占用") {
                            $("#fundAccountPeriod1").show();
                            $("#fundMonthRate1").show();
                            $("#dayPenalRate1").show();
                            $("#penalGracePeriod1").show();
                            $("#minSaleDay1").show();
                            $("#fixedpoints1").hide();
                            $("#spreadfixedpoints1").hide();
                        } else if ($("#isFundAccountName").html() == "价差") {
                            $("#fundAccountPeriod1").hide();
                            $("#fundMonthRate1").hide();
                            $("#dayPenalRate1").hide();
                            $("#penalGracePeriod1").hide();
                            $("#fixedpoints1").show();
                            $("#spreadfixedpoints1").show();
                            $("#minSaleDay1").hide();
                        } 
                     	if (data.isFundAccount == 1 && data.paypalCalcType == 2 && data.projectItemSegmentList) {
                      		if (data.projectItemSegmentList.length > 0) {
                      			for (var i=0; i<data.projectItemSegmentList.length; i++) {
                      				var segmentData = data.projectItemSegmentList[i];
                      				var segmentHtml = '';
                    	 			var segmentHtml = '<span class="segment-input-item" style="display:inline-block;width:100%;">' 
                    	 				 + '<label type="number" min="0" class="js-initform segment-day" id="segment-day">'+ segmentData.segmentDay + '</label>'
                    	 				 + '<span class="sign"> - </span>'
                    	 				 + '<label type="number" min="0" class="js-initform segment-fund-month-rate" id="segment-fund-month-rate">' + segmentData.segmentFundMonthRate + '</label>'
                    	 				 + ' (分段天数-服务费率)'
                    	 				 + '</span>';
                    	 			if (i != (data.projectItemSegmentList.length - 1)) {
                    	 				segmentHtml = segmentHtml + "<br>";
                    	 			}
                    	 			$('.segment-input-box').append(segmentHtml);  			 
                      			}		 
                      		}
                      	}
                        if($("#accountRateTypeValue").html() == "固定汇率"){ 
                             $("#accountRate1").show();  
                              $("#bankId1").hide().find("#bankName").val("");
                         }else if($("#accountRateTypeValue").html() == "结算日汇率"){ 
                            $("#bankId1").show(); 
                             $("#accountRate1").hide().find("#accountRate").val("");
                         }
                        if($("#isOperateAccountValue").html() == "无"){
                            $("#operateFeeRate1").hide().find("#operateFeeRate").val("");  
                        }
                        if($("#isAgencyExportValue").html() == "否"){
                            $("#agencyExportRate1").hide().find("#agencyExportRate").val("");
                        }
                        if($("#isagencyimportValue").html() == "否"){
                            $("#agencyimportrate1").hide().find("#agencyimportrate").val("");

                        }
                        if($("#fixedpointsValue").html() == "否"){
                            $("#spreadfixedpoints1").hide().find("#spreadfixedpoints").val(""); 
                        }
                        if($("#signStandardValue").html() == "身份证"){      
                            $("#certificateName1").show(); 
                            $("#certificateId1").show();
                        }else if($("#signStandardValue").html() == "公章"){  
                            $("#officialSeal1").show();
                        }else 
                            if($("#signStandardValue").html() == "身份证+公章"){  
                            $("#certificateName1").show(); 
                            $("#certificateId1").show(); 
                            $("#officialSeal1").show();
                        }
                    }  
                }
              //获取审核记录数据并在表格中展示
                GLOBAL.ajax('projectItem/auditflow/audit/query', {
                	projectItemId: poId
                }, function(e) {
                    var data = e.items;
                    if (data) {
                        var nodeLists = "";
                        for (var i = 0; i < data.length; i++) {

                            var bgFlag = data[i].backcolor,
                                fontFlag = data[i].fontcolor;
                            var state;
                            if(bgFlag == 1){
                                state = "passed"
                            }
                            if(fontFlag == "1"){
                                state = "reject";
                            }else if(fontFlag == "2"){
                                state = "current";
                            }
                            nodeLists += '<li class="'+state+'"><p>' + data[i].stateName + ' ' + data[i].dealName + ' (' + data[i].auditStateName + ') ' + data[i].suggestion + '<p>' + (data[i].createTime || "-") + '</p></li>'
                        }
                        $('.audit-record-box ul').empty().append(nodeLists);
                    }
                })

                
                
            });
        
    })
        GLOBAL.initSelect();
        $("#pass").click(function() {
            var suggestion = $("#suggestion").val();
            var url = $(this).data("url");
            GLOBAL.ajax(url, {
                auditId: id,
                projectItemId: poId,
                suggestion: suggestion || ""
            }, function(e) {
            	if (e.success) {
                    MOBILE.msg("审核通过成功！", function(){
                		window.location.href = "audit_list_new.html";
                	}); 
                } else {
                    MOBILE.msg(e.msg);
                }
            });
        })

        $("#sigh").click(function(e) {
            e.stopPropagation();
            var url = $(this).data("url");
            var sighId = $("#sighId").val();
            if(sighId){
                MOBILE.confirm('确定加签吗？', function(){
                    GLOBAL.ajax(url, {
                        auditId: id,
                        pauditorId: sighId
                    }, function(e) {
                        if (e.success) {
                            MOBILE.msg("加签成功！", function(){
                        		window.location.href = "audit_list_new.html";
                        	}); 
                        } else {
                            MOBILE.msg(e.msg);
                        }
                    });
                });
            }else{
                MOBILE.msg("请选择！");
                $("#sighId").focus();
            }
        })

        $("#deliver").click(function() {
            var url = $(this).data("url");
            var deliverId = $("#deliverId").val();
            if(deliverId){
                MOBILE.confirm('确定转交吗？', function(){ 
                    GLOBAL.ajax(url, {
                        auditId: id,
                        pauditorId: deliverId
                    }, function(e) {
                        if (e.success) {
                            MOBILE.msg("转交成功！", function(){
                        		window.location.href = "audit_list_new.html";
                        	}); 
                        } 
                    });
                });
            }else{
                MOBILE.msg("请选择！");
                $("#deliverId").focus();
            }
            
        })

        $("#unpass").click(function() {
            var suggestion = $("#suggestion").val();
            if (!suggestion) {
                MOBILE.msg("请输入审核意见");
                return;
            }
            var url = $(this).data("url");
            GLOBAL.ajax(url, {
                auditId: id,
                projectItemId:poId,
                suggestion: suggestion
            }, function(e) {
                if (e.success) {
                    MOBILE.msg("审核不通过成功！", function(){
                		window.location.href = "audit_list_new.html";
                	}); 
                } else {
                    MOBILE.msg(e.msg);
                }
            });
        })

        $(".js-back").click(function(){
            if(flag){
                location.href = "myApplying.html";
            }else{
                window.location.href = "audit_list_new.html";;
            }
        })
</script>
</body>

</html>
