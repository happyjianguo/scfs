<!DOCTYPE html>
<html>

<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>供应链金融</title>
<script src="../../js/lib/flexible.js" type="text/javascript"></script>
<link href="../../css/base.css" rel="stylesheet"></link>
<link href="../../css/public.css" rel="stylesheet"></link>
<link href="../../css/mobile.css" rel="stylesheet"></link>
<link href="../../css/msg.css" rel="stylesheet"></link>
<style>
.one, .two {
	display: none;
}
</style>
</head>

<body>
	<div class="wrapper mb20">
		<!--引入面包屑-->
		<div class="box no-margin">
			<form class="audit-form" id="payAuditInfoForm"
				data-url="payOrder/info/audit">
				<div class="box-header">
					<input class="js-initform" type="hidden" id="id" name="id">
					<h4 class="title mb10 ml5 mt5">
						<strong>财务专员审核</strong>
					</h4>
					<div class="box-inner">
						<div class="form-group">
							<label for="payNo"><b>付款编号：</b></label> <label
								class="js-initform" id="payNo" name="payNo"></label>
						</div>
						<div class="form-group">
							<label for="projectName"><b>项目：</b></label> <label
								class="js-initform" id="projectName" name="projectName"></label>
						</div>
						<div class="form-group">
							<label for="payTypeName"><b>付款类型：</b></label> <label
								class="js-initform" id="payTypeName" name="payTypeName"></label>
						</div>
						<div class="form-group">
							<label for="payWayName"><b>付款方式：</b></label> <label
								class="js-initform" id="payWayName" name="payWayName"></label>
						</div>
						<div class="form-group">
							<label for="payeeName"><b>收款单位：</b></label> <label
								class="js-initform" id="payeeName" name="payeeName"></label>
						</div>
						<div class="form-group">
							<label for="bankName"><b>银行：</b></label> <label
								class="js-initform" id="bankName" name="bankName"></label>
						</div>
						<div class="form-group">
							<label for="requestPayTime"><b>要求付款时间：</b></label> <label
								class="js-initform" id="requestPayTime" name="requestPayTime"></label>
						</div>
						<div class="form-group">
							<label for="accountNo"><b>收款账号：</b></label> <label
								class="js-initform" id="accountNo" name="accountNo"></label>
						</div>
						<div class="form-group">
							<label for="payAmount"><b>付款金额：</b></label> <label
								class="js-initform toThound" id="payAmount" name="payAmount"></label>
						</div>
						<div class="form-group">
							<label for="defaultCurrency"><b>付款币种：</b></label> <label
								class="js-initform" id="defaultCurrency" name="defaultCurrency"></label>
						</div>
						<div class="form-group">
							<label for="advanceAmount"><b>预收金额：</b></label> <label
								class="js-initform toThound" id="advanceAmount"
								name="advanceAmount"></label>
						</div>
						<div class="form-group">
							<label for="advanceAmountRateName"><b>预收比例：</b></label> <label
								class="js-initform" id="advanceAmountRateName"
								name="advanceAmountRateName"></label>
						</div>
						<div class="form-group">
							<label for="payAdvanceAmount"><b>占用额度：</b></label> <label
								class="js-initform toThound" id="payAdvanceAmount"
								name="payAdvanceAmount"></label>
						</div>
						<div class="form-group">
							<label for="payAdvanceAmountRateName"><b>占用比例：</b></label> <label
								class="js-initform" id="payAdvanceAmountRateName"
								name="payAdvanceAmountRateName"></label>
						</div>
						<div class="form-group">
							<label for="projectBalanceAmount"><b>付款前项目余额：</b></label> <label
								class="js-initform toThound" id="projectBalanceAmount"
								name="projectBalanceAmount"></label>
						</div>
						<div class="form-group">
							<label for="payProjectBalanceAmount"><b>付款后项目余额：</b></label> <label
								class="js-initform toThound" id="payProjectBalanceAmount"
								name="payProjectBalanceAmount"></label>
						</div>
						<div class="form-group">
							<label for="projectTotalAmount"><b>项目总额度：</b></label> <label
								class="js-initform toThound" id="projectTotalAmount"
								name="projectTotalAmount"></label>
						</div>
						<div class="form-group">
							<label for="openType"><b>开立类型：</b></label> <label
								class="js-initform" id="openType" name="openType"></label>
						</div>
						<div class="form-group">
							<label for="discountRateStr"><b>折扣率：</b></label> <label
								class="js-initform" id="discountRateStr" name="discountRateStr"></label>
						</div>
						<div class="form-group">
							<label for="remark"><b>备注：</b></label> <label class="js-initform"
								id="remark" name="remark"></label>
						</div>
					</div>
				</div>
				<!-- /.box-header -->
				<div class="box-body">
					<h3 class="title one mb10 ml5 mt5">
						<strong>付款订单明细</strong>
					</h3>
					<h3 class="title two mb10 ml5 mt5">
						<strong>付款费用明细</strong>
					</h3>
					<table id="js_dataTable" class="table table-border"></table>
					<h3 class="title mb10 ml5 mt5">
						<strong>付款预收明细</strong>
					</h3>
					<table id="js_advance_dataTable" class="table table-border"></table>
				</div>
				<div class="box-body">
					<!-- <h4  class="title mb10 ml5 mt5"><strong>附件</strong></h4>
                        <table id="js_dataFileTable"  class="table table-border"></table> -->
					<h4 class="title mb10 ml5 mt5">
						<strong>审核记录</strong>
					</h4>
					<table id="js_audit_dataTable" class="table table-border"></table>
				</div>
				<!-- .box-body -->
				<div class="box-footer text-center mb10">
					<div class="form-inline" id="buttom1">
						<textarea class="form-control js-initform" id="suggestion"
							rows="3" name="suggestion" placeholder="审核意见"></textarea>
						<p class="mt20">
							<button type="button" data-url="payOrder/finance/audit"
								class="btn btn-primary btn-sm" id="pass">审核通过</button>
							<button type="button" data-url="payOrder/unpass/audit"
								class="btn btn-primary btn-sm punpass" id="unpass">审核不通过</button>
							<button type="button" class="btn btn-default btn-sm js-back">返回</button>
						</p>
						<div class="row mt20 psigh" style="display: none">
							<label class="control-label col-md-2">加签给:</label> <select
								class="form-control col-md-8 js-select" data-url="USER"
								id="sighId" name="sighId"></select>
							<button type="button" data-url="payOrder/sigh/audit"
								class="btn btn-primary btn-sm col-md-2" id="sigh">加签</button>
						</div>
						<div class="row mt20 pdeliver" style="display: none">
							<label class="control-label col-md-2">转交给:</label> <select
								class="form-control col-md-8 js-select" data-url="USER"
								id="deliverId" name="deliverId"></select>
							<button type="button" data-url="payOrder/deliver/audit"
								class="btn btn-primary btn-sm col-md-2" id="deliver">转交</button>
						</div>
					</div>
					<div class="form-inline" style="display: none" id="buttom2">
						<p class="mt20">
							<button type="button" class="btn btn-default btn-sm js-back">返回</button>
						</p>
					</div>
				</div>
				<!-- /.box-footer -->
			</form>
		</div>
		</section>
	</div>
	<script src="../../../js/lib/jquery-1.11.0.min.js"
		type="text/javascript"></script>
	<script src="../../js/common.js?v=1.0.0"></script>
	<script>
        var id = GLOBAL.getParam("id");
        var poId = GLOBAL.getParam("poId");
        var flag = GLOBAL.getParam("flag");

        if (flag) {
            $('#buttom2').show();
            $('#buttom1').hide();
        }

        $(function() {
            var $from = $("#payAuditInfoForm");
            var url = $from.data("url");
            GLOBAL.ajax(url, {
                payId: poId
            }, function(e) {
                if (e.success) {
                    var data = e.items.payOrderResDto;
                    var type;
                    if (data) {
                        type = data.payType;
                        $(".js-initform", $from).each(function() {
                            var $this = $(this);
                            var id = $this.attr("id");
                            data[id] = data[id] == null ? "" : data[id];

                            if (this.nodeName.toLowerCase() == "span") {
                                if (data[id]) {
                                    if ($this.attr('class') == "js-initform toThound") {
                                        $this.text(data[id].toThounds());
                                    } else {
                                        $this.text(data[id]);
                                    }
                                }
                            } else {
                                $this.val(data[id]);
                            }
                        });
                    }

                    var payAdvanceRelation = e.items.payAdvanceRelation;
                    if (payAdvanceRelation) {
                        var tabStr = "";
                        for (var i = 0; i < payAdvanceRelation.length; i++) {
                            tabStr += '<tbody><tr><td rowspan="4" class="column-index">' + (i + 1) + '</td></tr>' +
                                '<tr><td>项目：</td><td>' + payAdvanceRelation[i].projectName + '</td><td>客户：</td><td>' + payAdvanceRelation[i].custName + '</td></tr>' +
                                '<tr><td>水单日期：</td><td>' + payAdvanceRelation[i].receiptDate + '</td><td>经营单位：</td><td>' + payAdvanceRelation[i].busiUnit + '</td>/tr>' +
                                '<tr><td>币种</td><<td>' + payAdvanceRelation[i].currencyTypeName + '</td><td>金额：</td><td colspan="3">' + payAdvanceRelation[i].payAmount.toThounds() + '</td></tr>' +
                                '</td></tr><tr class="empty-tr"><td colspan="5"></td></tr></tbody>';
                        }
                        $('#js_advance_dataTable').append(tabStr);
                    }

                    var tabId;
                    if (type) {
                        if (type == 1) {
                            var dtls = e.items.payPoRelationResDto;
                            tabId = 1;
                            if (dtls) {
                                var tabStr = "";
                                for (var i = 0; i < dtls.length; i++) {
                                    tabStr += '<tbody><tr><td rowspan="7" class="column-index">' + (i + 1) + '</td></tr>' +
                                        '<tr><td>订单编号：</td><td>' + dtls[i].orderNo + '</td><td>订单附属编号：</td><td>' + dtls[i].appendNo + '</td></tr>' +
                                        '<tr><td>订单日期：</td><td>' + dtls[i].orderTime + '</td><td>采购数量</td><td>' + dtls[i].goodsNum + '</td></tr>' +
                                        '<tr><td>采购单价：</td><td>' + dtls[i].goodsPrice.toThounds() + '</td><td>销售价：</td><td>' + dtls[i].requiredSendPrice.toThounds() + '</td></tr>' +
                                        '<tr><td>折扣率：</td><td>' + dtls[i].discountRateStr + '%</td><td>币种：</td><td>' + dtls[i].currencyName + '</td></tr>' +
                                        '<tr><td>采购金额：</td><td>' + dtls[i].goodsAmount.toThounds() + '</td><td>已收货金额：</td><td>' + dtls[i].arrivalAmount.toThounds() + '</td></tr>' +
                                        '<tr><td>本次付款金额：</td><td colspan="3">' + dtls[i].payAmount.toThounds() + '</td></tr>' +
                                        '</td></tr><tr class="empty-tr"><td colspan="5"></td></tr></tbody>';
                                }
                                $('#js_dataTable').append(tabStr);
                            }
                        }
                        if (type == 2) {
                            var fees = e.items.payFeeRelationResDto;
                            tabId = 2;
                            if (fees) {
                                var tabStr = "";
                                for (var i = 0; i < fees.length; i++) {
                                    tabStr += '<tbody><tr><td rowspan="4" class="column-index">' + (i + 1) + '</td></tr>' +
                                        '<tr><td>费用编号：</td><td>' + fees[i].feeNo + '</td><td>费用类型：</td><td>' + fees[i].feeTypeName + '</td></tr>' +
                                        '<tr><td>费用日期：</td><td>' + fees[i].payDate + '</td><td>费用金额</td><td>' + fees[i].expPayAmount.toThounds() + '</td></tr>' +
                                        '<tr><td>已收票金额：</td><td>' + fees[i].acceptInvoiceAmount.toThounds() + '</td><td>本次付款金额：</td><td>' + fees[i].payAmount.toThounds() + '</td></tr>' +
                                        '</td></tr><tr class="empty-tr"><td colspan="5"></td></tr></tbody>';
                                }
                                $('#js_dataTable').append(tabStr);
                            }
                        }
                        var tabArr = ["one", "two", "three"];
                        $("." + tabArr[tabId - 1]).show();
                    }

                    //获取审核记录数据并在表格中展示
                    GLOBAL.ajax('payOrder/auditflow/audit/query', {
                        projectItemId: poId
                    }, function(e) {
                        var data = e.items;
                        if (data) {
                            var tabStr = "";
                            for (var i = 0; i < data.length; i++) {

                                var bgFlag = data[i].backcolor,
                                    fontFlag = data[i].fontcolor;

                                if (bgFlag || fontFlag) {
                                    var backcolor = ["", "#d0daf2"],
                                        fontColor = ["", "red", "blue"];
                                }
                                if (bgFlag == 2) {
                                    var borderColor = "";
                                }

                                tabStr += '<tbody><tr><td rowspan="4" class="column-index" style="background-color: ' + backcolor[bgFlag] + ';color: ' + fontColor[fontFlag] + '">' + (i + 1) + '</td></tr><tr style="background-color: ' +
                                    backcolor[bgFlag] + ';color: ' + fontColor[fontFlag] + '"><td style="width:1rem">节点：</td><td style="width:4rem">' + data[i].stateName + "<span>(" + data[i].auditStateName + ')</span></td><td style="width:1.5rem">处理人：</td>' + '<td>' + data[i].dealName + '</td></tr><tr style="background-color: ' + backcolor[bgFlag] + ';color: ' +
                                    fontColor[fontFlag] + '"><td>时间：</td><td colspan="3">' + data[i].createTime + '&nbsp;&nbsp;-&nbsp;&nbsp;' + data[i].dealTime + '</td></tr><tr style="background-color: ' + backcolor[bgFlag] + ';color: ' + fontColor[fontFlag] + '"><td>意见：</td><td colspan="3">' + data[i].suggestion +
                                    '</td></tr>' + '<tr class="empty-tr"><td colspan="5"></td></tr></tbody>';
                            }
                            $('#js_audit_dataTable').append(tabStr);
                        }
                    })



                    GLOBAL.ajax('audit/id/query', {
                        id: id
                    }, function(e) {
                        var data = e.items;
                        if (data) {
                            if (data.auditType == 1 || data.auditType == 2) {
                                $(".psigh,.pdeliver").show();
                            } else {
                                $(".punpass").hide();
                            }
                            if (data.auditState == 1 || data.auditState == 3) { //审核通过，隐藏
                                $('#buttom2').show();
                                $('#buttom1').hide();
                            }
                        }
                    });
                }
            });
        })

        GLOBAL.initSelect();

        $("#pass").click(function() {
            var suggestion = $("#suggestion").val();
            var url = $(this).data("url");
            GLOBAL.ajax(url, {
                auditId: id,
                projectItemId: poId,
                suggestion: suggestion || ""
            }, function(e) {
                if (e.success) {
                    MOBILE.msg("已审核通过！", function() {
                        window.location.href = "audit_list_new.html";
                    });
                } else {
                    MOBILE.msg(e.msg);
                }
            });
        })

        $("#sigh").click(function() {
            var url = $(this).data("url");
            var sighId = $("#sighId").val();
            if (sighId) {
                MOBILE.confirm('确定加签吗？', function() {
                    GLOBAL.ajax(url, {
                        auditId: id,
                        pauditorId: sighId
                    }, function(e) {
                        if (e.success) {
                            MOBILE.msg("加签成功！", function() {
                                window.location.href = "audit_list_new.html";
                            });
                        } else {
                            MOBILE.msg(e.msg);
                        }
                    });
                });
            } else {
                MOBILE.msg("请选择！");
                $("#sighId").focus();
            }
        })

        $("#deliver").click(function() {
            var url = $(this).data("url");
            var deliverId = $("#deliverId").val();
            if (deliverId) {
                MOBILE.confirm('确定转交吗？', function() {
                    GLOBAL.ajax(url, {
                        auditId: id,
                        pauditorId: deliverId
                    }, function(e) {
                        if (e.success) {
                            MOBILE.msg("转交成功！", function() {
                                window.location.href = "audit_list_new.html";
                            });
                        } else {
                            MOBILE.msg(e.msg);
                        }
                    });
                });
            } else {
                MOBILE.msg("请选择！");
                $("#deliverId").focus();
            }
        })
        $("#unpass").click(function() {
            var suggestion = $("#suggestion").val();
            if (!suggestion) {
                MOBILE.msg("请输入审核意见");
                return;
            }
            var url = $(this).data("url");
            GLOBAL.ajax(url, {
                auditId: id,
                projectItemId: poId,
                suggestion: suggestion
            }, function(e) {
                if (e.success) {
                    MOBILE.msg("审核未通过！", function() {
                        window.location.href = "audit_list_new.html";
                    });
                } else {
                    MOBILE.msg(e.msg);
                }
            });
        })

        $(".js-back").click(function() {
            if (flag) {
                location.href = "myApplying.html";
            } else {
                window.location.href = "audit_list_new.html";;
            }
        })
        </script>
</body>

</html>
