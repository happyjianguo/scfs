<!DOCTYPE html>
<html>

<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>供应链金融</title>
<script src="../../js/lib/flexible.js" type="text/javascript"></script>
<link href="../../css/base.css" rel="stylesheet"></link>
<link href="../../css/public.css" rel="stylesheet"></link>
<link href="../../css/mobile.css" rel="stylesheet"></link>
<link href="../../css/msg.css" rel="stylesheet"></link>
</head>

<body>
	<div class="wrapper mb20">
		<!--引入面包屑-->
		<div class="box no-margin">
			<form class="audit-form" id="billDeliveryAuditInfoForm"
				data-url="billDelivery/info/audit">
				<div class="box-header">
					<input class="js-initform" type="hidden" id="id" name="id">
					<h4 class="title mb10 ml5 mt5">
						<strong>财务主管审核</strong>
					</h4>
					<div class="box-inner">
						<div class="form-group">
							<label for="billNo"><b>销售单编号：</b></label> <label
								class="js-initform" id="billNo" name="billNo"></label>
						</div>
						<div class="form-group">
							<label for="affiliateNo"><b>销售附属编号：</b></label> <label
								class="js-initform" id="affiliateNo" name="affiliateNo"></label>
						</div>
						<div class="form-group">
							<label for="projectName"><b>项目：</b></label> <label
								class="js-initform" id="projectName" name="projectName"></label>
						</div>
						<div class="form-group">
							<label for="warehouseName"><b>销售仓库：</b></label> <label
								class="js-initform" id="warehouseName" name="warehouseName"></label>
						</div>
						<div class="form-group">
							<label for="customerName"><b>客户：</b></label> <label
								class="js-initform" id="customerName" name="customerName"></label>
						</div>
						<div class="form-group">
							<label for="transferModeName"><b>运输方式：</b></label> <label
								class="js-initform" id="transferModeName"
								name="transferModeName"></label>
						</div>
						<div class="form-group">
							<label for="customerAddress"><b>收货地址：</b></label> <label
								class="js-initform" id="customerAddress" name="customerAddress"></label>
						</div>
						<div class="form-group">
							<label for="requiredSendDate"><b>销售日期：</b></label> <label
								class="js-initform" id="requiredSendDate"
								name="requiredSendDate"></label>
						</div>
						<div class="form-group">
							<label for="statusName"><b>状态：</b></label> <label
								class="js-initform" id="statusName" name="statusName"></label>
						</div>
						<div class="form-group">
							<label for="requiredSendNum"><b>总数量：</b></label> <label
								class="js-initform" id="requiredSendNum" name="requiredSendNum"></label>
						</div>
						<div class="form-group">
							<label for="requiredSendAmount"><b>总金额：</b></label> <label
								class="js-initform" id="requiredSendAmount"
								name="requiredSendAmount"></label>
						</div>
						<div class="form-group">
							<label for="payAmount"><b>资金占用金额：</b></label> <label
								class="js-initform" id="payAmount" name="payAmount"></label>
						</div>
						<div class="form-group">
							<label for="preRecAmount"><b>预收金额：</b></label> <label
								class="js-initform" id="preRecAmount" name="preRecAmount"></label>
						</div>
						<div class="form-group">
							<label for="serviceAmount"><b>服务金额：</b></label> <label
								class="js-initform" id="serviceAmount" name="serviceAmount"></label>
						</div>
						<div class="form-group">
							<label for="currencyTypeName"><b>币种：</b></label> <label
								class="js-initform" id="currencyTypeName"
								name="currencyTypeName"></label>
						</div>
						<div class="form-group">
							<label for="signStandardName"><b>签收标准：</b></label> <label
								class="js-initform" id="signStandardName"
								name="signStandardName"></label>
						</div>
						<div class="form-group">
							<label for="certificateName"><b>签收人：</b></label> <label
								class="js-initform" id="certificateName" name="certificateName"></label>
						</div>
						<div class="form-group">
							<label for="certificateId"><b>身份证：</b></label> <label
								class="js-initform" id="certificateId" name="certificateId"></label>
						</div>
						<div class="form-group">
							<label for="officialSeal"><b>公章：</b></label> <label
								class="js-initform" id="officialSeal" name="officialSeal"></label>
						</div>
						<div class="form-group">
							<label for="remark"><b>备注：</b></label> <label class="js-initform"
								id="remark" name="remark"></label>
						</div>
						<div class="form-group">
							<label for="arrivalAmount"><b>到账金额：</b></label> <label
								class="js-initform" id="arrivalAmount" name="arrivalAmount"></label>
						</div>
						<div class="form-group td_parentReceiptDate_title">
							<label for="returnTime"><b>到账日期：</b></label> <label
								class="js-initform" id="returnTime" name="returnTime"></label>
						</div>
					</div>
				</div>
				<!-- /.box-header -->
				<div class="box-body">
					<h3 class="title mb10 ml5 mt5">水单明细</h3>
					<table id="js_po_dataTable" class="table table-border">
						<tbody></tbody>
					</table>
				</div>
				<div class="box-body">
					<h3 class="title mb10 ml5 mt5">销售单明细</h3>
					<table id="js_dataTable" class="table table-border"></table>
				</div>
				<div class="box-body">
					<h3 class="title mb10 ml5 mt5">审核记录</h3>
					<table id="js_audit_dataTable" class="table table-border"></table>
				</div>
				<!-- .box-body -->
				<div class="box-footer text-center mb10">
					<div class="form-inline" id="buttom1">
						<textarea class="form-control js-initform" id="suggestion"
							rows="3" name="suggestion" placeholder="审核意见"></textarea>
						<p class="mt20">
							<button type="button" data-url="billDelivery/finance2/audit"
								class="btn btn-primary btn-sm" id="pass">审核通过</button>
							<button type="button" data-url="billDelivery/unpass/audit"
								class="btn btn-primary btn-sm punpass" id="unpass">审核不通过</button>
							<button type="button" class="btn btn-default btn-sm js-back">返回</button>
						</p>
						<div class="row mt20 psigh" style="display: none">
							<label class="control-label col-md-2">加签给:</label> <select
								class="form-control col-md-8 js-select" data-url="USER"
								id="sighId" name="sighId"></select>
							<button type="button" data-url="billDelivery/sigh/audit"
								class="btn btn-primary btn-sm col-md-2" id="sigh">加签</button>
						</div>
						<div class="row mt20 pdeliver" style="display: none">
							<label class="control-label col-md-2">转交给:</label> <select
								class="form-control col-md-8 js-select" data-url="USER"
								id="deliverId" name="deliverId"></select>
							<button type="button" data-url="billDelivery/deliver/audit"
								class="btn btn-primary btn-sm col-md-2" id="deliver">转交</button>
						</div>

					</div>
					<div class="form-inline" style="display: none" id="buttom2">
						<p class="mt20">
							<button type="button" class="btn btn-default btn-sm js-back">返回</button>
						</p>
					</div>
				</div>
				<!-- /.box-footer -->
			</form>
		</div>
		</section>
	</div>
	<script src="../../../js/lib/jquery-1.11.0.min.js"
		type="text/javascript"></script>
	<script src="../../js/common.js?v=1.0.0"></script>
	<script>
        var id = GLOBAL.getParam("id");
        var poId = GLOBAL.getParam("poId");
        var flag = GLOBAL.getParam("flag");
        var auditId = GLOBAL.getParam("auditId");
        var receiptDate = null;
        var $form = $("#billDeliveryAuditInfoForm");
        var url = $form.data("url");

        if(flag){
            $('#buttom2').show();
            $('#buttom1').hide();
        }

        $(function(){

            GLOBAL.ajax(url, {
                id: poId,
                receiptDate: receiptDate
            }, function(e) {
                if (e.success) {
                    var data = e.items.billDeliveryResDto;
                    if (data) {
                        showFormData(data);
                    }
                    
                    //添加销售单明细信息
                    var dtls = e.items.billDeliveryDtlResDtoList;
                    if (dtls) {
                        shwoBillDeliveryDtlResDtoList(dtls);
                    }
                }
            });
            
          //水单明细表
           initPoTable();


            //审核记录数据
            GLOBAL.ajax('billDelivery/auditflow/audit/query', {
                billDeliveryId: poId
            }, function(e) {
                var data = e.items;
                if (data) {
                    var tabStr = "";
                    var backcolor = ["", "#d0daf2"],
                        fontColor = ["", "red", "blue"];

                    for (var i = 0; i < data.length; i++) {

                        var bgFlag = data[i].backcolor,
                            fontFlag = data[i].fontcolor;

                        tabStr += '<tbody><tr><td rowspan="4" class="column-index" style="background-color: ' + backcolor[bgFlag] + ';color: ' + fontColor[fontFlag] + '">' + (i + 1) + '</td></tr><tr style="background-color: ' + 
			            			backcolor[bgFlag] + ';color: ' + fontColor[fontFlag] + '"><td style="width:1rem">节点：</td><td style="width:4rem">' + data[i].stateName +"<span>("+data[i].auditStateName+ ')</span></td><td style="width:1.5rem">处理人：</td>' + '<td>' + data[i].dealName + '</td></tr><tr style="background-color: ' + backcolor[bgFlag] + ';color: ' +
			            			fontColor[fontFlag] + '"><td>时间：</td><td colspan="3">' + data[i].createTime + '&nbsp;&nbsp;-&nbsp;&nbsp;' + data[i].dealTime + '</td></tr><tr style="background-color: ' + backcolor[bgFlag] + ';color: ' + fontColor[fontFlag] + '"><td>意见：</td><td colspan="3">' + data[i].suggestion + 
			            			'</td></tr>' + '<tr class="empty-tr"><td colspan="5"></td></tr></tbody>';
                    }
                    $('#js_audit_dataTable').append(tabStr);
                }
            })

            GLOBAL.ajax('audit/id/query', {
                id: id
            }, function(e) {
                var data = e.items;
                if (data) {
                    if (data.auditType == 1 || data.auditType == 2) {
                        $(".psigh,.pdeliver").show();
                    } else {
                        $(".punpass").hide();
                    }
                    if(data.auditState == 1 || data.auditState == 3){//审核通过，隐藏
                        $('#buttom2').show();
                        $('#buttom1').hide();
                    }
                }
            });
        })

        GLOBAL.initSelect();

        //初始化水单表
        function initPoTable() {
            GLOBAL.ajax('billDelivery/fiBankReceipt/audit/query', {
                id: poId,
                auditId: id,
                receiptDate: receiptDate
            }, function(e) {
                var data = e.items;
                if (data) {
                    var tabStr = "";
                    for (var i = 0; i < data.length; i++) {
                        var isCheck = data[i].checked ? ' checked="checked"' : "";
                        var addItem = data[i].checked ? ' add-item' : "";
                        tabStr += '<tbody><tr><td rowspan="5" class="column-index">' + (i + 1) + '</td></tr>' +
                            '<tr><td>水单号：</td><td>' + data[i].parentReceiptNo + "-" + data[i].receiptNo + '</td><td>水单类型：</td><td>' + data[i].receiptTypeName + '</td></tr>' +
                            '<tr><td>到账日期：</td><td>' + data[i].parentReceiptDate + '</td><td>摘要：</td><td>' + data[i].parentSummary + '</td></tr>' + '</td></tr><tr><td>到账金额：</td><td style="font-size:.5rem">' + data[i].parentReceiptAmount + '</td><td>余额</td><td>' + data[i].remainAmount + '</td></tr>' + '</td></tr>' + '<tr><td>选择金额：</td><td colspan="3"> <input type="text" readonly="readonly" class="form-control po-cash-box availableAmount '+addItem+'" value="' + data[i].availableAmount + '" style="height:50px;font-size:.5rem"/></td></tr>' +
                            +'</td></tr><tr class="empty-tr"><td colspan="5"></td></tr></tbody>';
                    }
                    $('#js_po_dataTable tbody').empty().append(tabStr);
                    sum();
                }
            });
        }

        //填充表单数据
        function showFormData(data){
            $(".js-initform", $form).each(function() {
                var $this = $(this);
                var id = $this.attr("id");
                var toThound = $this.hasClass("toThound");
                data[id] = data[id] == null ? "" : data[id];

                if (this.nodeName.toLowerCase() == "span") {
                    if (data[id]) {
                        var showValue = toThound && !isNaN(parseFloat(data[id])) ? parseFloat(data[id]).toThounds() : data[id];
                        $this.text(showValue);
                    }
                } else {
                    $this.val(data[id]);
                }
            });
            if (!receiptDate) {
            	receiptDate = data.returnTime;
            }
            if (data.settleType && data.settleType == 1) {
            	alert(data.settleType)
                $(".td_parentReceiptDate_title").hide();
                //$(".td_parentReceiptDate").hide();
            }
        } 
        //填充销售单明细表格数据
        function shwoBillDeliveryDtlResDtoList(dtls){
            var tabStr = "";
            for (var i = 0; i < dtls.length; i++) {
                tabStr += '<tbody><tr><td rowspan="8" class="column-index">' + (i + 1) + '</td></tr>' +
                    '<tr><td>商品编号：</td><td>' + dtls[i].goodsNumber + '</td><td>商品条码：</td><td>' + dtls[i].goodsBarCode + '</td></tr>' +
                    '<tr><td>商品名称：</td><td>' + dtls[i].goodsName + '</td><td>商品型号：</td><td>' + dtls[i].goodsType + '</td></tr>' +
                    '<tr><td>销售数量：</td><td>' + dtls[i].requiredSendNum + '</td><td>销售单价：</td><td>' + dtls[i].requiredSendPrice + '</td></tr>' +
                    '<tr><td>销售金额：</td><td>' + dtls[i].requiredSendAmount + '</td><td>资金占用金额：</td><td>' + dtls[i].payAmount + '</td></tr>' +
                    '<tr><td>资金占用天数：</td><td>' + dtls[i].payDays + '</td><td>服务费率：</td><td>' + dtls[i].fundMonthRate + '</td></tr>' +
                    '<tr><td>服务金额：</td><td>' + dtls[i].serviceAmount + '</td><td>其他费用：</td><td>' + dtls[i].otherAmount + '</td></tr>' +
                    '<tr><td>批次：</td><td>' + dtls[i].batchNo + '</td><td>库存状态：</td><td>' + dtls[i].goodsStatusName + '</td></tr>' +
                    '</td></tr><tr class="empty-tr"><td colspan="8"></td></tr></tbody>';
            }
            $('#js_dataTable').append(tabStr);
        }


        function sum(){
            var $selectedRows = $('#js_po_dataTable .add-item');
            var sum = 0;
            $selectedRows.each(function(){
                var val = $(this).val();
                if(val){
                    sum += parseFloat(val);
                }
            })
            sum = sum.toFixed(2);
            $("#requiredSendAmount").text();
            $("#arrivalAmount").text(sum);
        }

        $("#pass").click(function() {
            var suggestion = $("#suggestion").val();
            var url = $(this).data("url");
            GLOBAL.ajax(url, {
                auditId: id,
                billDeliveryId: poId,
                suggestion: suggestion || ""
            }, function(e) {
                if (e.success) {
                    MOBILE.msg("已审核通过！", function() {
                        window.location.href = "audit_list_new.html";
                    });
                } else {
                    MOBILE.msg(e.msg);
                }
            });
        })

        $("#unpass").click(function() {
            var suggestion = $("#suggestion").val();
            if (!suggestion) {
                MOBILE.msg("请输入审核意见");
                return;
            }
            var url = $(this).data("url");
            GLOBAL.ajax(url, {
                auditId: id,
                billDeliveryId: poId,
                suggestion: suggestion
            }, function(e) {
                if (e.success) {
                    MOBILE.msg("审核未通过！", function() {
                        window.location.href = "audit_list_new.html";
                    });
                } else {
                    MOBILE.msg(e.msg);
                }
            });
        })

        $("#sigh").click(function() {
            var url = $(this).data("url");
            var sighId = $("#sighId").val();
            if (sighId) {
                MOBILE.confirm('确定加签吗？', function() {
                    GLOBAL.ajax(url, {
                        auditId: id,
                        pauditorId: sighId
                    }, function(e) {
                        if (e.success) {
                            MOBILE.msg("加签成功！", function() {
                                window.location.href = "audit_list_new.html";
                            });
                        } else {
                            MOBILE.msg(e.msg);
                        }
                    });
                });
            } else {
                MOBILE.msg("请选择！");
                $("#sighId").focus();
            }
        })

        $("#deliver").click(function() {
            var url = $(this).data("url");
            var deliverId = $("#deliverId").val();
            if (deliverId) {
                MOBILE.confirm('确定转交吗？', function() {
                    GLOBAL.ajax(url, {
                        auditId: id,
                        pauditorId: deliverId
                    }, function(e) {
                        if (e.success) {
                            MOBILE.msg("转交成功！", function() {
                                window.location.href = "audit_list_new.html";
                            });
                        } else {
                            MOBILE.msg(e.msg);
                        }
                    });
                });
            } else {
                MOBILE.msg("请选择！");
                $("#deliverId").focus();
            }
        })

        $(".attachment-down").click(function() {
            var ids = GLOBAL.selectIds($("#js_dataFileTable"));
            if (ids) {
                var url = GLOBAL.host + $(this).data("url") + "?ids=" + ids;
                window.open(url);
            }
        })

        $(".js-back").click(function(){
            if(flag){
                location.href = "myApplying.html";
            }else{
                window.location.href = "audit_list_new.html";;
            }
        })
    </script>
</body>

</html>
