<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>供应链金融</title>
<script src="../../js/lib/flexible.js" type="text/javascript"></script>
<link href="../../css/base.css" rel="stylesheet"></link>
<link href="../../css/public.css" rel="stylesheet"></link>
<link href="../../css/mobile.css" rel="stylesheet"></link>
<link href="../../css/msg.css" rel="stylesheet"></link>
</head>

<body>
	<div class="wrapper mb20">
		<!--引入面包屑-->
		<div class="box no-margin">

			<form class="audit-form" id="poAuditInfoForm"
				data-url="po/info/audit">
				<div class="box-header">
					<input class="js-initform" type="hidden" id="id" name="id">
					<h4 class="title mb10 ml5 mt5">
						<strong>业务审核</strong>
					</h4>
					<div class="box-inner">
						<div class="form-group">
							<label for="billNo"><b>订单编号：</b></label> <label
								class="js-initform" id="orderNo" name="orderNo"></label>
						</div>
						<div class="form-group">
							<label for="affiliateNo"><b>订单附属编号：</b></label> <label
								class="js-initform" id="appendNo" name="appendNo"></label>
						</div>
						<div class="form-group">
							<label for="billTypeName"><b>项目：</b></label> <label
								class="js-initform" id="projectName" name="projectName"></label>
						</div>
						<div class="form-group">
							<label for="projectName"><b>供应商：</b></label> <label
								class="js-initform" id="supplierName" name="supplierName"></label>
						</div>
						<div class="form-group">
							<label for="warehouseName"><b>收货仓库：</b></label> <label
								class="js-initform" id="warehouseName" name="warehouseName"></label>
						</div>
						<div class="form-group">
							<label for="customerName"><b>客户：</b></label> <label
								class="js-initform" id="customerName" name="customerName"></label>
						</div>
						<div class="form-group">
							<label for="transferModeName"><b>订单日期：</b></label> <label
								class="js-initform" id="orderTime" name="orderTime"></label>
						</div>
						<div class="form-group">
							<label for="customerAddress"><b>预计到货时间：</b></label> <label
								type="text" class="js-initform" id="perdictTime"
								name="perdictTime"></label>
						</div>
						<div class="form-group">
							<label for="requiredSendDate"><b>仓库地址：</b></label> <label
								class="js-initform" id="wareAddrName" name="wareAddrName"></label>
						</div>
						<div class="form-group">
							<label for="statusName"><b>订单数量：</b></label> <label
								class="js-initform" id="orderTotalNum" name="orderTotalNum"></label>
						</div>
						<div class="form-group">
							<label for="requiredSendNum"><b>订单金额：</b></label> <label
								class="js-initform" id="orderTotalAmount"
								name="orderTotalAmount"></label>
						</div>
						<div class="form-group">
							<label for="requiredSendAmount"><b>可用额度：</b></label> <label
								class="js-initform" id="availAmount" name=""></label>
						</div>
						<div class="form-group">
							<label for="signStandardName"><b>本次占用额度：</b></label> <label
								class="js-initform" id="useAmount" name="useAmount"></label>
						</div>
						<div class="form-group">
							<label for="certificateName"><b>剩余额度：</b></label> <label
								class="js-initform" id="" name=""></label>
						</div>
						<div class="form-group">
							<label for="certificateId"><b>付款：</b></label> <label
								class="js-initform" id="isRequestPayName"
								name="isRequestPayName"></label>
						</div>
						<div class="form-group">
							<label for="officialSeal"><b>申请付款金额：</b></label> <label
								class="js-initform" id="payAmount" name="payAmount"></label>
						</div>
						<div class="form-group">
							<label for="remark"><b>付款方式：</b></label> <label
								class="js-initform" id="payWayName" name="payWayName"></label>
						</div>
						<div class="form-group">
							<label for="officialSeal"><b>银行：</b></label> <label
								class="js-initform" id="bankName" name="bankName"></label>
						</div>
						<div class="form-group">
							<label for="remark"><b>付款账号：</b></label> <label
								class="js-initform" id="accountNo" name="accountNo"></label>
						</div>
						<div class="form-group">
							<label for="officialSeal"><b>要求付款时间：</b></label> <label
								class="js-initform" id="requestPayTime" name="requestPayTime"></label>
						</div>
						<div class="form-group">
							<label for="remark"><b>付款币种：</b></label> <label
								class="js-initform" id="currencyName" name="currencyName"></label>
						</div>
						<div class="form-group">
							<label for="officialSeal"><b>开立类型：</b></label> <label
								class="js-initform" id="openType" name="openType"></label>
						</div>
						<div class="form-group">
							<label for="remark"><b>备注：</b></label> <label class="js-initform"
								id="remark" name="remark"></label>
						</div>
					</div>
				</div>

				<!-- /.box-header -->
				<div class="box-body">
					<!-- <h4 class="title mb10 ml5 mt5"><strong>水单明细</strong></h4>
                            <table id="js_po_dataTable" class="ml5 mr5" data-url="billDelivery/fiBankReceipt/audit/query"></table> -->
					<h4 class="title mb10 ml5 mt5">
						<strong>采购订单明细</strong>
					</h4>
					<table id="js_dataTable" class="table table-border"></table>
					<h4 class="title mb10 ml5 mt5">
						<strong>审核记录</strong>
					</h4>
					<table id="js_audit_dataTable" class="table table-border"></table>
				</div>
				<!-- .box-body -->
				<div class="box-footer text-center mb10">
					<div class="form-inline" id="buttom1">
						<textarea class="form-control js-initform" id="suggestion"
							rows="3" name="suggestion" placeholder="审核意见"></textarea>
						<p class="mt20">
							<button type="button" data-url="po/bus/audit"
								data-permissionUrl="/po/bus/audit"
								class="btn btn-primary btn-sm" id="pass">审核通过</button>
							<button type="button" data-url="po/unpass/audit"
								data-permissionUrl="/po/unpass/audit"
								class="btn btn-primary btn-sm punpass" id="unpass">审核不通过</button>
							<button type="button" class="btn btn-default btn-sm js-back">返回</button>
						</p>
						<div class="row mt20 psigh" style="display: none">
							<label class="control-label pull-rihgt">加签给:</label> <select
								class="form-control js-select" data-url="USER" id="sighId"
								name="sighId"></select>
							<button type="button" data-url="po/sigh/audit"
								data-permissionUrl="/po/sigh/audit"
								class="btn btn-primary btn-sm" id="sigh">加签</button>
						</div>
						<div class="row mt20 pdeliver" style="display: none">
							<label class="control-label pull-rihgt">转交给:</label> <select
								class="form-control js-select" data-url="USER" id="deliverId"
								name="deliverId"></select>
							<button type="button" data-url="po/deliver/audit"
								data-permissionUrl="/po/deliver/audit"
								class="btn btn-primary btn-sm" id="deliver">转交</button>
						</div>
					</div>
					<div class="form-inline" style="display: none" id="buttom2">
						<p class="mt20">
							<button type="button" class="btn btn-default btn-sm js-back">返回</button>
						</p>
					</div>
				</div>
				<!-- /.box-footer -->
			</form>
		</div>
	</div>

	<script src="../../../js/lib/jquery-1.11.0.min.js"
		type="text/javascript"></script>
	<script src="../../js/common.js"></script>
	<script>

            var id = GLOBAL.getParam("id");
            var poId = GLOBAL.getParam("poId");
            var flag = GLOBAL.getParam("flag");
            if(flag){
                $('#buttom2').show();
                $('#buttom1').hide();
            }

            $(function() {
                var $from = $("#poAuditInfoForm");
                var url = $from.data("url");
                GLOBAL.ajax(url, {
                    id: id
                }, function(e) {
                    if (e.success) {
                        var data = e.items.billDeliveryResDto;
                        if (data) {
                            $(".js-initform", $from).each(function() {
                                var $this = $(this);
                                var id = $this.attr("id");
                                data[id] = data[id] == null ? "" : data[id];

                                if (this.nodeName.toLowerCase() == "span") {
                                    if (data[id]) {
                                        $this.text(data[id]);
                                    }
                                } else {
                                    $this.val(data[id]);
                                }
                            });
                        }

                        //将销售单明细数据在表格中展示
                        var dtls = e.items.billDeliveryDtlResDtoList;
                        if (dtls) {
                            var tabStr = "";
                            for (var i = 0; i < dtls.length; i++) {
                                tabStr += '<div class="detail-item"><p><span class="form-label">商品编号：' + dtls[i].goodsNumber + '</span><span class="form-value">商品条码：' + dtls[i].goodsBarCode + '</span></p><p><span class="form-label">商品名称：' + dtls[i].goodsName + '</span><span class="form-value">销售数量：' + dtls[i].requiredSendNum + '</span></p><p><span class="form-label">销售单价：' + dtls[i].requiredSendPrice + '</span><span class="form-value">销售金额：' + dtls[i].requiredSendAmount + '</span></p><p><span class="form-label">批次：' + dtls[i].batchNo + '</span><span class="form-value">库存状态：' + dtls[i].goodsStatusName + '</span></p></div>';
                            }
                            $('#js_dataTable').append(tabStr);
                        }
                    }
                });

                //获取审核记录数据并在表格中展示
                GLOBAL.ajax('po/auditflow/audit/query', {
                    poId: poId
                }, function(e) {
                    var data = e.items;
                    if (data) {
                        var tabStr = "";
                        for (var i = 0; i < data.length; i++) {

                            var bgFlag = data[i].backcolor,
                                fontFlag = data[i].fontcolor;

                            if(bgFlag || fontFlag){
                                var backcolor = ["", "#d0daf2"],
                                    fontColor = ["", "red", "blue"];
                            }
                            if(bgFlag == 2){
                                var borderColor = "";
                            }

                            tabStr += '<tbody><td rowspan="5" class="column-index" style="background-color: '+backcolor[bgFlag]+';color: '+fontColor[fontFlag]+'">'+(i+1)+'</td></tr><tr style="background-color: '+backcolor[bgFlag]+';color: '+fontColor[fontFlag]+'"><td>流程节点：</td><td>' + data[i].stateName + '</td><td>处理人：</td><td>' + data[i].dealName + '</td></tr><tr style="background-color: '+backcolor[bgFlag]+';color: '+fontColor[fontFlag]+'"><td>开始时间：</td><td>' + data[i].createTime + '</td><td>处理时间：</td><td>' + data[i].dealTime + '</td></tr><tr style="background-color: '+backcolor[bgFlag]+';color: '+fontColor[fontFlag]+'"><td>处理意见：</td><td colspan="3">' + data[i].suggestion + '</td></tr><tr style="background-color: '+backcolor[bgFlag]+';color: '+fontColor[fontFlag]+'"><td>处理状态：</td><td colspan="3">' + data[i].auditStateName + '</td></tr><tr class="empty-tr"><td colspan="5"></td></tr></tbody>';
                        }
                        $('#js_audit_dataTable').append(tabStr);
                    }
                })
                
                GLOBAL.ajax('audit/id/query', {
                    id: id
                }, function(e) {
                    var data = e.items;
                    if (data) {
                        if (data.auditType == 1 || data.auditType == 2) {
                            $(".psigh,.pdeliver").show();
                        } else {
                            $(".punpass").hide();
                        }

                        if(data.auditState == 1 || data.auditState == 3){//审核通过，隐藏
                            $('#buttom2').show();
                            $('#buttom1').hide();
                        }
                    }
                });
            })

            GLOBAL.initSelect();

            $("#pass").click(function() {
                var suggestion = $("#suggestion").val();
                if(suggestion == ""){
                    MOBILE.msg('请输入审核意见');
                    return;
                }
                var url = $(this).data("url");
                GLOBAL.ajax(url, {
                    auditId: id,
                    billDeliveryId: poId,
                    suggestion: suggestion || ""
                }, function(e) {
                    if (e.success) {
                        MOBILE.msg("审核通过成功！");
                        window.location.href = "audit_list_new.html";
                    } else {
                        MOBILE.msg(e.msg);
                    }
                });
            })

            $("#unpass").click(function() {
                var suggestion = $("#suggestion").val();
                if (suggestion == "") {
                    MOBILE.msg("请输入审核意见");
                    return;
                }
                var url = $(this).data("url");
                GLOBAL.ajax(url, {
                    auditId: poId,
                    billDeliveryId: poId,
                    suggestion: suggestion
                }, function(e) {
                    if (e.success) {
                        MOBILE.msg("审核不通过成功！");
                        window.location.href = "audit_list_new.html";
                    } else {
                        MOBILE.msg(e.msg);
                    }
                });
            })

            $(".js-back").click(function(){
                window.location.href = "audit_list_new.html";
            })

            $("#sigh").click(function() {
                var url = $(this).data("url");
                var sighId = $("#sighId").val();

                if (sighId) {
                    MOBILE.confirm('确定加签吗？', {
                        btn: ['确定', '取消'] //按钮
                    }, function() {
                        GLOBAL.ajax(url, {
                            auditId: poId,
                            pauditorId: sighId
                        }, function(e) {
                            if (e.success) {
                                MOBILE.msg("加签成功！");
                                $("#sighId").val("");
                                GLOBAL.tableRefresh($('#js_audit_dataTable'), {
                                    billDeliveryId: poId
                                });
                            } else {
                                MOBILE.msg(e.msg);
                            }
                        });
                    });
                } else {
                    MOBILE.msg("请选择！");
                    $("#sighId").focus();
                }
            })

            $("#deliver").click(function() {
                var url = $(this).data("url");
                var deliverId = $("#deliverId").val();

                if (deliverId) {
                    MOBILE.confirm('确定转交吗？', function() {
                        GLOBAL.ajax(url, {
                            auditId: poId,
                            pauditorId: deliverId
                        }, function(e) {
                            if (e.success) {
                                MOBILE.msg("转交成功！");
                                $("#deliverId").val("");
                                if (options.param.entryType == 1) {
                                    GLOBAL.go("html/entry.html");
                                } else {
                                    GLOBAL.go("html/audit/audit.html");
                                }
                            } else {
                                MOBILE.msg(e.msg);
                            }
                        });
                    });
                } else {
                    MOBILE.msg("请选择！");
                    $("#deliverId").focus();
                }
            })
            $(".js-back").click(function(){
                if(flag){
                    location.href = "myApplying.html";
                }else{
                    window.location.href = "audit_list_new.html";;
                }
            })
        </script>
</body>
</html>



