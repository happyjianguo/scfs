<!DOCTYPE html>
<html>

<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>瑞翰供应链</title>
<script src="../../js/lib/flexible.js" type="text/javascript"></script>
<link href="../../css/base.css" rel="stylesheet"></link>
<link href="../../css/public.css" rel="stylesheet"></link>
<link href="../../css/mobile.css" rel="stylesheet"></link>
<link href="../../css/msg.css" rel="stylesheet"></link>
</head>

<body>
	<div class="wrapper mb20">
		<input class="js-initform" type="hidden" id="id" name="id">
		<h4 class="title mb10 ml5 mt5">
			<strong>财务专员审核</strong>
		</h4>
		<form class="audit-form" id="billDeliveryAuditInfoForm"
			data-url="billDelivery/info/audit">
			<input class="js-initform" type="hidden" id="id" name="id">
			<p>
				<span class="form-label">销售单编号</span> <span
					class="form-value js-initform" id="billNo"></span>
			</p>
			<p>
				<span class="form-label">销售附属编号</span> <span
					class="form-value js-initform" id="affiliateNo"></span>
			</p>
			<p>
				<span class="form-label">项目</span> <span
					class="form-value js-initform" id="projectName"></span>
			</p>
			<p>
				<span class="form-label">销售仓库</span> <span
					class="form-value js-initform" id="warehouseName"></span>
			</p>
			<p>
				<span class="form-label">客户</span> <span
					class="form-value js-initform" id="customerName"></span>
			</p>
			<p>
				<span class="form-label">运输方式</span> <span
					class="form-value js-initform" id="transferModeName"></span>
			</p>
			<p>
				<span class="form-label">收货地址</span> <span
					class="form-value js-initform" id="customerAddress"></span>
			</p>
			<p>
				<span class="form-label">销售日期</span> <span
					class="form-value js-initform" id="requiredSendDate"></span>
			</p>
			<p>
				<span class="form-label">状态</span> <span
					class="form-value js-initform" id="statusName"></span>
			</p>
			<p>
				<span class="form-label">总数量</span> <span
					class="form-value js-initform" id="requiredSendNum"></span>
			</p>
			<p>
				<span class="form-label">总金额</span> <span
					class="form-value js-initform" id="requiredSendAmount"></span>
			</p>
			<p>
				<span class="form-label">资金占用金额</span> <span
					class="form-value js-initform" id="payAmount"></span>
			</p>
			<p>
				<span class="form-label">预收金额</span> <span
					class="form-value js-initform" id="preRecAmount"></span>
			</p>
			<p>
				<span class="form-label">服务金额</span> <span
					class="form-value js-initform" id="serviceAmount"></span>
			</p>
			<p>
				<span class="form-label">币种</span> <span
					class="form-value js-initform" id="currencyTypeName"></span>
			</p>
			<p>
				<span class="form-label">签收标准</span> <span
					class="form-value js-initform" id="signStandardName"></span>
			</p>
			<p>
				<span class="form-label">签收人</span> <span
					class="form-value js-initform" id="certificateName"></span>
			</p>
			<p>
				<span class="form-label">身份证</span> <span
					class="form-value js-initform" id="certificateId"></span>
			</p>
			<p>
				<span class="form-label">公章</span> <span
					class="form-value js-initform" id="officialSeal"></span>
			</p>
			<p>
				<span class="form-label">备注</span> <span
					class="form-value js-initform" id="remark"></span>
			</p>
			<p>
				<span class="form-label">到账金额</span> <span
					class="form-value js-initform" id="arrivalAmount"></span>
			</p>
			<p>
				<span class="form-label">到账日期</span> <select
					style="width: 300px; height: 75px;" class="form-control form-value"
					id="parentReceiptDate" name="parentReceiptDate">
				</select>
			</p>
		</form>

		<h3 class="title mb10 ml5 mt5">水单明细</h3>
		<div class="detail-box" id="js_po_dataTable"></div>

		<h3 class="title mb10 ml5 mt5">抵扣水单明细</h3>
		<div class="detail-box" id="js_recDeduction_dataTable"></div>

		<h3 class="title mb10 ml5 mt5">销售单明细</h3>
		<div class="detail-box" id="js_dataTable"></div>

		<h4 class="title mb10 ml5 mt5 audit-record-title">
			<strong>审核节点</strong>
		</h4>
		<div class="audit-record-box">
			<ul></ul>
		</div>

		<div class="box-footer text-center mb10">
			<div class="form-inline" id="buttom1">
				<textarea class="form-control js-initform" id="suggestion" rows="3"
					name="suggestion" placeholder="审核意见"></textarea>
				<p class="mt20">
					<button type="button" data-url="billDelivery/finance/audit"
						class="btn btn-primary btn-sm" id="pass">审核通过</button>
					<button type="button" data-url="billDelivery/unpass/audit"
						class="btn btn-primary btn-sm punpass" id="unpass">审核不通过</button>
					<button type="button" class="btn btn-default btn-sm js-back">返回</button>
				</p>
				<div class="row mt20 psigh" style="display: none">
					<label class="control-label col-md-2">加签给:</label> <select
						class="form-control col-md-8 js-select" data-url="USER"
						id="sighId" name="sighId"></select>
					<button type="button" data-url="billDelivery/sigh/audit"
						class="btn btn-primary btn-sm col-md-2" id="sigh">加签</button>
				</div>
				<div class="row mt20 pdeliver" style="display: none">
					<label class="control-label col-md-2">转交给:</label> <select
						class="form-control col-md-8 js-select" data-url="USER"
						id="deliverId" name="deliverId"></select>
					<button type="button" data-url="billDelivery/deliver/audit"
						class="btn btn-primary btn-sm col-md-2" id="deliver">转交</button>
				</div>
			</div>

			<div class="form-inline" style="display: none" id="buttom2">
				<p class="mt20">
					<button type="button" class="btn btn-default btn-sm js-back">返回</button>
				</p>
			</div>
		</div>
	</div>
	<script src="../../../js/lib/jquery-1.11.0.min.js"
		type="text/javascript"></script>
	<script src="../../js/common.js?v=1.0.0"></script>
	<script>
    var id = GLOBAL.getParam("id");
    var poId = GLOBAL.getParam("poId");
    var flag = GLOBAL.getParam("flag");
    var auditId = GLOBAL.getParam("id");
    var receiptDate = null;
    var poData = null;
    var $form = $("#billDeliveryAuditInfoForm");
    var url = $form.data("url");

    if(flag){
        $('#buttom2').show();
        $('#buttom1').hide();
    }

    $(function(){
        var selectedOptions = "";
        GLOBAL.ajax("billDelivery/fiBankReceiptDate/audit/query", {
            id: poId
        }, function(data) {
            if (data.items) {
                data = data.items;
                receiptDate = data[0].value;
                for (var i = 0; i < data.length; i++) {
                    selectedOptions += '<option value="' + data[i].code + '">' + data[i].value + '</option>';
                }
                $("#parentReceiptDate").empty().append(selectedOptions);
            } else {
                $("#parentReceiptDate").empty();
            }
        });
        //水单明细表
        initPoTable();
        // 抵扣水单明细
        deDuctionTable();
		
        $('#js_po_dataTable').on("input", ".po-cash-box", function(){
            var val = $(this).val();
    	    var remainAmount = $(this).attr("init-val").replace(/,/g, "");
            var balance = parseFloat(remainAmount);
            if(val <= balance){
              sum();
            }else{
              MOBILE.msg("不能大于余额");
              $(this).val(balance);
            }
        });
        
        $('#js_recDeduction_dataTable').on("input", ".po-cash-box", function(){
            var val = $(this).val();
    	    var remainAmount = $(this).attr("init-val").replace(/,/g, "");
            var balance = parseFloat(remainAmount);
            if(val <= balance){
            	ductionSum();
            }else{
              MOBILE.msg("不能大于余额");
              $(this).val(balance);
            }
        });

        GLOBAL.ajax(url, {
            id: poId,
            receiptDate: receiptDate
        }, function(e) {
            if (e.success) {
                var data = e.items.billDeliveryResDto;
                if (data) {
                    showFormData(data);
                } 
                //添加销售单明细信息
                var dtls = e.items.billDeliveryDtlResDtoList;
                if (dtls) {
                    shwoBillDeliveryDtlResDtoList(dtls);
                }
            }
        });

        //审核记录数据
        GLOBAL.ajax('billDelivery/auditflow/audit/query', {
            billDeliveryId: poId
        }, function(e) {
            var data = e.items;
            if (data) {
                var nodeLists = "";
                for (var i = 0; i < data.length; i++) {

                    var bgFlag = data[i].backcolor,
                        fontFlag = data[i].fontcolor;
                    var state;
                    if(bgFlag == 1){
                        state = "passed"
                    }
                    if(fontFlag == "1"){
                        state = "reject";
                    }else if(fontFlag == "2"){
                        state = "current";
                    }
                    nodeLists += '<li class="'+state+'"><p>' + data[i].stateName + ' ' + data[i].dealName + ' (' + data[i].auditStateName + ') ' + data[i].suggestion + '<p>' + (data[i].createTime || "-") + '</p></li>'
                }
                $('.audit-record-box ul').empty().append(nodeLists);
            }
        })

        GLOBAL.ajax('audit/id/query', {
            id: id
        }, function(e) {
            var data = e.items;
            if (data) {
                if (data.auditType == 1 || data.auditType == 2) {
                    $(".psigh,.pdeliver").show();
                } else {
                    $(".punpass").hide();
                }

                if(data.auditState == 1 || data.auditState == 3){//审核通过，隐藏
                    $('#buttom2').show();
                    $('#buttom1').hide();
                }

            }
        });
    })

    GLOBAL.initSelect();
    //初始化水单表
    function initPoTable() {
        GLOBAL.ajax('billDelivery/fiBankReceipt/audit/query', {
            id: poId,
            auditId: auditId,
            receiptDate: receiptDate
        }, function(e) {
            var data = e.items;
            poData = data;
            if (data) {
                var tabStr = "";
                for (var i = 0; i < data.length; i++) {
                    var isCheck = data[i].checked ? ' checked="checked"' : "";
                    var whereCheck = data[i].checked ? ' checked' : "";
                    var addItem = data[i].checked ? ' add-item' : "";
                    var isDisabled = data[i].disabled ? ' disabled="disabled"' : "";
                    var whetherDisabled = data[i].disabled ? 'disabled' : "";
                    tabStr += '<div class="detail-item"><span class="checkbox-label '+whereCheck+' '+ whetherDisabled +'"><input type="checkbox" '+isCheck+' '+isDisabled+' class="checkbox-audit-item"/></span> <input type="hidden" class="id" value='+data[i].id+'><p><span class="form-label" style="width:100%">水单号：' + data[i].parentReceiptNo + "-" + data[i].receiptNo + '</span></p><p><span class="form-label">水单类型：<span class="receiptType">'
					+ data[i].receiptType+ '</span></span><span class="form-label">到账日期：<span class="parentReceiptDate">' + data[i].parentReceiptDate + '</span></span></p><p><span class="form-value">摘要：' + data[i].parentSummary + '</span><span class="form-label">到账金额：' + data[i].parentReceiptAmount + '</span></p><p><span class="form-value">余额：' + data[i].remainAmount + '</span></p><p><span class="form-label" style="width:100%;">选择金额：<input type="text" class="form-control po-cash-box availableAmount '+addItem+'" value="' + data[i].availableAmount + '" init-val="' + data[i].availableAmount + '"'+isDisabled+'/></p></div>';
                }

                $('#js_po_dataTable').empty().append(tabStr);

                $('#js_po_dataTable input[type="checkbox"]').click(function(){
                	sum();
                })
                
               	$('#js_po_dataTable').on("input", ".availableAmount", function(){
               		sum();
               	});
                
                sum();
            }
        });
    }
  //抵扣水单明细
  function   deDuctionTable(){
      GLOBAL.ajax('billDelivery/fiBankReceipt/advance/audit/query', {
          id: poId,
          auditId: auditId,
          receiptDate: receiptDate
      },function(e){
    	   var data = e.items;
           poData = data;
           if(data){
        	     var tabStr = "";
                 for (var i = 0; i < data.length; i++) {
                     var isCheck = data[i].checked ? ' checked="checked"' : "";
                     var whereCheck = data[i].checked ? ' checked' : "";
                     var addItem = data[i].checked ? ' add-item' : "";
                     var isDisabled = data[i].disabled ? ' disabled="disabled"' : "";
                     var whetherDisabled = data[i].disabled ? 'disabled' : "";
                     tabStr += '<div class="detail-item"><span class="checkbox-label '+whereCheck+' '+ whetherDisabled +'"><input type="checkbox" '+isCheck+' '+isDisabled+' class="checkbox-audit-item"/></span> <input type="hidden" class="id" value='+data[i].id+'> <p><span class="form-label" style="width:100%">水单号：' + data[i].parentReceiptNo + "-" + data[i].receiptNo + '</span></p><p><span class="form-label">水单类型：<span class="receiptType">' + data[i].receiptType + '</span></span><span class="form-label">到账日期：<span class="parentReceiptDate">' + data[i].parentReceiptDate + '</span></span></p><p><span class="form-value">摘要：' + data[i].parentSummary + '</span><span class="form-label">到账金额：' + data[i].parentReceiptAmount + '</span></p><p><span class="form-value">余额：' + data[i].remainAmount + '</span></p><p><span class="form-label" style="width:100%;">选择金额：<input type="text" class="form-control po-cash-box availableAmount '+addItem+'" value="' + data[i].availableAmount + '" init-val="' + data[i].availableAmount + '"'+isDisabled+'/></p></div>';
                 }
                 $('#js_recDeduction_dataTable').empty().append(tabStr);

                 $('#js_recDeduction_dataTable input[type="checkbox"]').click(function(){
                	 ductionSum();
                 })
                	$('#js_recDeduction_dataTable').on("input", ".availableAmount", function(){
                		ductionSum();
                	});
                 ductionSum();
           }
      });
  }
    
    //填充表单数据
    function showFormData(data){
        $(".js-initform", $form).each(function() {
            var $this = $(this);
            var id = $this.attr("id");
            var toThound = $this.hasClass("toThound");
            data[id] = data[id] == null ? "" : data[id];

            if (this.nodeName.toLowerCase() == "span") {
                if (data[id]) {
                    var showValue = toThound && !isNaN(parseFloat(data[id])) ? parseFloat(data[id]).toThounds() : data[id];
                    $this.text(showValue);
                }
            } else {
                $this.val(data[id]);
            }
        });
    } 
    //填充销售单明细表格数据
    function shwoBillDeliveryDtlResDtoList(dtls){
        var tabStr = "";
        for (var i = 0; i < dtls.length; i++) {
            tabStr += '<div class="detail-item"><p><span class="form-label">商品编号：' + dtls[i].goodsNumber + '</span><span class="form-value">商品条码：' + dtls[i].goodsBarCode + '</span></p><p><span class="form-label">商品名称：' + dtls[i].goodsName + '</span><span class="form-value">商品型号：' + dtls[i].goodsType + '</span></p><p><span class="form-label">销售数量：' + dtls[i].requiredSendNum + '</span><span class="form-value">销售单价：' + dtls[i].requiredSendPrice + '</span></p><p><span class="form-label">销售金额：' + dtls[i].requiredSendAmount + '</span><span class="form-value">资金占用金额：' + dtls[i].payAmount.toThounds() + '</span></p><p><span class="form-label">资金占用天数：' + dtls[i].payDays + '</span><span class="form-value">服务费率：' + dtls[i].otherAmount + '</span></p><p><p><span class="form-label">服务金额：' + dtls[i].serviceAmount.toThounds() + '</span><span class="form-value">其他费用：' + dtls[i].otherAmount.toThounds() + '</span></p><p><span class="form-label">批次：' + dtls[i].batchNo + '</span><span class="form-value">库存状态：' + dtls[i].goodsStatusName + '</span></p></div>';

        }
        $('#js_dataTable').empty().append(tabStr);
    }

    $("#js_po_dataTable").on("click", ".checkbox-label", function(){
        if($(this).hasClass("disabled")){return;}
        var opt = $(this).hasClass("checked") ? "removeClass" : "addClass";
        $(this)[opt]("checked");
        $(this).find("input[type='checkbox']").prop("checked", $(this).hasClass("checked"));
        sum();
    })

    function sum(){
        var $selectedRows = $('#js_po_dataTable :checked');
        var sum = 0;
        $selectedRows.each(function(){
            var val = $(this).closest(".detail-item").find(".availableAmount").val();
            if(val){
                sum += parseFloat(val);
            }
        })
        $selectedRows = $('#js_recDeduction_dataTable :checked');
        var ductionSum = 0;
        $selectedRows.each(function(){
            var val = $(this).closest(".detail-item").find(".availableAmount").val();
            if(val){
            	ductionSum += parseFloat(val);
            }
        })
         sum += parseFloat(ductionSum);
        MOBILE.msg("到账金额：" + sum);
        $("#requiredSendAmount").text();
        $("#arrivalAmount").text(sum.toFixed(2));
    }
    
    $("#js_recDeduction_dataTable").on("click", ".checkbox-label", function(){
        if($(this).hasClass("disabled")){return;}
        var opt = $(this).hasClass("checked") ? "removeClass" : "addClass";
        $(this)[opt]("checked");
        $(this).find("input[type='checkbox']").prop("checked", $(this).hasClass("checked"));
        ductionSum();
    })

    function   ductionSum(){
        var selectedRows = $('#js_recDeduction_dataTable :checked');
        var ductionSum = 0;
        selectedRows.each(function(){
            var val = $(this).closest(".detail-item").find(".availableAmount").val();
            if(val){
            	ductionSum += parseFloat(val);
            }
        })
        selectedRows = $('#js_po_dataTable :checked');
        var sum = 0;
        selectedRows.each(function(){
            var val = $(this).closest(".detail-item").find(".availableAmount").val();
            if(val){
                sum += parseFloat(val);
            }
        })
    	ductionSum += parseFloat(sum);
        MOBILE.msg("到账金额：" + ductionSum.toFixed(2));
        $("#requiredSendAmount").text();
        $("#arrivalAmount").text(ductionSum.toFixed(2));
    	}
    
    $('#parentReceiptDate').change(function() {
        var thisValue = $(this).val();
        if (!thisValue) {
            return;
        }
        receiptDate = thisValue;
        initPoTable();
        deDuctionTable();
        GLOBAL.ajax(url, {
            id: poId,
            receiptDate: receiptDate
        }, function(e) {
            if (e.success) {
                var data = e.items.billDeliveryResDto;
                if (data) {
                    showFormData(data);
                }
            }
        });
    });

    $("#pass").click(function() {
    	var suggestion = $("#suggestion").val();
        var url = $(this).data("url");
    	var selectedRows = $('#js_po_dataTable :checked');
        var idsLen = selectedRows.length;
        var rows = [];
        var isValid = true;
        
        selectedRows.each(function(){
        	var row = new Object();
        	var $tbody = $(this).closest(".detail-item");
        	var availableAmount = $tbody.find(".availableAmount").val();
        	if (!availableAmount) {
        		isValid = false;
            	MOBILE.msg("选择余额必填且正确，请重新输入");
                return false;
            }
            if (availableAmount*1 <= 0) {
            	isValid = false;
            	MOBILE.msg("选择余额不能为负数和零，请重新输入");
                return false;
            }
            row.receiptId = $tbody.find(".id").val();
            row.receiptNo = $tbody.find(".parentReceiptNo").text();
            row.receiptType = $tbody.find(".receiptType").text();
            row.receiptDate = $tbody.find(".parentReceiptDate").text();
            row.receiptAmount = $tbody.find(".parentReceiptAmount").text();
            row.remainAmount = $tbody.find(".remainAmount").text();
            row.availableAmount = availableAmount;
            rows.push(row);
        })
        
        // 抵扣水单
        var selectedRows = $('#js_recDeduction_dataTable :checked');
        var idsLen = selectedRows.length;
        var dectionRows = [];
        selectedRows.each(function(){
        	var dectionRow = new Object();
        	var $tbody = $(this).closest(".detail-item");
        	var availableAmount = $tbody.find(".availableAmount").val();
        	if (!availableAmount) {
        		isValid = false;
            	MOBILE.msg("选择余额必填且正确，请重新输入");
                return false;
            }
            if (availableAmount*1 <= 0) {
            	isValid = false;
            	MOBILE.msg("选择余额不能为负数和零，请重新输入");
                return false;
            }
            dectionRow.receiptId = $tbody.find(".id").val();
            dectionRow.receiptNo = $tbody.find(".parentReceiptNo").text();
            dectionRow.receiptType = $tbody.find(".receiptType").text();
            dectionRow.receiptAmount = $tbody.find(".parentReceiptAmount").text();
            dectionRow.remainAmount = $tbody.find(".remainAmount").text();
            dectionRow.availableAmount = availableAmount;
            dectionRows.push(dectionRow);
        })
        
    	var params = {
    	    auditId: id,
    	    billDeliveryId: poId,
    	    suggestion: suggestion || "",
    	    receiptDate: $('#parentReceiptDate').val(),
    	    verificationAdvanceList: rows,
    	    advanceMentList :dectionRows
    	};
        
        isValid && GLOBAL.ajax(url, JSON.stringify(params), function(e) {
            if (e.success) {
                MOBILE.msg("已审核通过！", function() {
                    window.location.href = "audit_list_new.html";
                });
            } else {
                MOBILE.msg(e.msg);
            }
        },true);
    })

    $("#unpass").click(function() {
        var suggestion = $("#suggestion").val();
        if (!suggestion) {
            MOBILE.msg("请输入审核意见");
            return;
        }
        var url = $(this).data("url");
        GLOBAL.ajax(url, {
            auditId: id,
            billDeliveryId: poId,
            suggestion: suggestion
        }, function(e) {
            if (e.success) {
                MOBILE.msg("审核未通过！", function() {
                    window.location.href = "audit_list_new.html";
                });
            } else {
                MOBILE.msg(e.msg);
            }
        });
    })

    $("#sigh").click(function() {
        var url = $(this).data("url");
        var sighId = $("#sighId").val();
        if (sighId) {
            MOBILE.confirm('确定加签吗？', function() {
                GLOBAL.ajax(url, {
                    auditId: id,
                    pauditorId: sighId
                }, function(e) {
                    if (e.success) {
                        MOBILE.msg("加签成功！", function() {
                            window.location.href = "audit_list_new.html";
                        });
                    } else {
                        MOBILE.msg(e.msg);
                    }
                });
            });
        } else {
            MOBILE.msg("请选择！");
            $("#sighId").focus();
        }
    })

    $("#deliver").click(function() {
        var url = $(this).data("url");
        var deliverId = $("#deliverId").val();
        if (deliverId) {
            MOBILE.confirm('确定转交吗？', function() {
                GLOBAL.ajax(url, {
                    auditId: id,
                    pauditorId: deliverId
                }, function(e) {
                    if (e.success) {
                        MOBILE.msg("转交成功！", function() {
                            window.location.href = "audit_list_new.html";
                        });
                    } else {
                        MOBILE.msg(e.msg);
                    }
                });
            });
        } else {
            MOBILE.msg("请选择！");
            $("#deliverId").focus();
        }
    })

    $(".attachment-down").click(function() {
        var ids = GLOBAL.selectIds($("#js_dataFileTable"));
        if (ids) {
            var url = GLOBAL.host + $(this).data("url") + "?ids=" + ids;
            window.open(url);
        }
    })

    $(".js-back").click(function(){
        if(flag){
            location.href = "myApplying.html";
        }else{
            window.location.href = "audit_list_new.html";;
        }
    })
    </script>
</body>

</html>
